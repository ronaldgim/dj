{% extends 'base_vue.html' %}

{% block title %}
<title>Resumen Cerezos</title>
{% endblock %}

{% block navbar %}
{% include 'inventario/topnavbar.html' %}
{% endblock %}

{% block body_2 %}

<div id="app">

    <h5 class="m-4 text-center fw-bold">RESUMEN CEREZOS</h5>
    
    <div class="mt-2 mb-2">
        <button @click="getStock()" class="btn btn-sm btn-primary">
            <span v-if="actualizandoStock" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
            <i v-else class="bi bi-arrow-clockwise"></i> ACTUALIZAR DATOS
        </button>
    </div>
    <div class="btn-group mb-3" role="group">
        <button 
            @click="aplicarFiltroTodo()" 
            :class="{'btn-primary': !filtroEstado, 'btn-outline-primary': filtroEstado}" 
            class="btn btn-sm">
            Todo
        </button>
        <button 
            @click="aplicarFiltroDiferencia0()" 
            :class="{'btn-success': filtroEstado === 'diferencia0', 'btn-outline-success': filtroEstado !== 'diferencia0'}" 
            class="btn btn-sm">
            Diferencia 0
        </button>
        <button 
            @click="aplicarFiltroLlenado()" 
            :class="{'btn-info': filtroEstado === 'lleno', 'btn-outline-info': filtroEstado !== 'lleno'}" 
            class="btn btn-sm">
            Llenado
        </button>
    </div>

    {% verbatim%}
    <div>
    Total de registros:
        {{stockFiltrado.length }}
    </div>
    {% endverbatim%}

    <div class="card mb-4">
        <div class="card-header">RESUMEN CEREZOS</div>
        <div class="card-body">
            <div class="col-4 mb-3">
                <input v-model="filtro" placeholder="Buscar..." type="text" class="form-control">
            </div>
            <div class="mt-2 mb-2">
                <button 
                    @click="limpiarOrden()" 
                    class="btn btn-sm btn-secondary"
                    v-if="sortField"
                >
                    Limpiar Ordenamiento
                </button>
            </div>
            <div class="table-responsive">
                <table class="table" id="inv_table" style="font-size: small;">
                    <thead>
                        <tr class="text-smaller">
                            <th 
                                scope="col"              
                                @click="ordenarPor('product_id')" 
                                style="cursor: pointer; user-select: none;"
                                :class="{ 'sorted': sortField === 'product_id' }"
                            >
                            <span style="white-space: nowrap;">
                                Código {% verbatim %}{{ getIconoOrden('product_id') }}{% endverbatim %}
                            </span>
                            </th>
                            <th 
                                scope="col"
                                @click="ordenarPor('Nombre')" 
                                style="cursor: pointer; user-select: none;"
                                :class="{ 'sorted': sortField === 'Nombre' }"
                            >
                            <span style="white-space: nowrap;">
                                Nombre {% verbatim %}{{ getIconoOrden('Nombre') }}{% endverbatim %}
                            </span>
                            </th>
                            <th 
                                scope="col"
                                @click="ordenarPor('Marca')" 
                                style="cursor: pointer;user-select: none;"
                                :class="{ 'sorted': sortField === 'Marca' }"
                            > 
                            <span style="white-space: nowrap;">
                                Marca {% verbatim %}{{ getIconoOrden('Marca') }}{% endverbatim %}
                            </span>
                            </th>
                            <th 
                                scope="col"
                                @click="ordenarPor('oh2')" 
                                style="cursor: pointer;user-select: none; background-color: #caf7ffff;"
                                :class="{ 'sorted': sortField === 'oh2' }"
                            >
                            <span style="white-space: nowrap;">
                                Und.Cerezos MBA {% verbatim %}{{ getIconoOrden('oh2') }}{% endverbatim %}
                            </span>
                            </th>
                            <th 
                                scope="col"
                                @click="ordenarPor('total_unidade')" 
                                style="cursor: pointer;user-select: none; background-color: #caf7ffff;"
                                :class="{ 'sorted': sortField === 'total_unidade' }"
                            >
                            <span style="white-space: nowrap;">
                                T.F.Cerezos {% verbatim %}{{ getIconoOrden('total_unidade') }}{% endverbatim %}
                            </span>
                            </th>
                            <th 
                                scope="col"
                                @click="ordenarPor('diferencia')" 
                                style="cursor: pointer;user-select: none;"
                                :class="{ 'sorted': sortField === 'diferencia' }"
                            >
                            <span style="white-space: nowrap;">
                                Diferencia {% verbatim %}{{ getIconoOrden('diferencia') }}{% endverbatim %}
                            </span>
                            </th>
                            <th scope="col">Llenado</th>
                            <th scope="col">Detalles</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% verbatim %}
                        <template v-for="(i, index) in stockFiltrado" :key="index">
                        <tr :class="expandedRow === i.product_id ? 'fw-bold' : ''">
                            <td>{{ i.product_id }}</td>
                            <td>{{ i.Nombre }}</td>
                            <td>{{ i.Marca }}</td>
                            <td class="text-end" style="background-color: #caf7ffff;">{{ formatNumber(i.oh2) }}</td>
                            <td class="text-end" style="background-color: #caf7ffff;">{{ formatNumber(i.total_unidades) }}</td>
                            <td class="text-end">{{ formatNumber(i.diferencia) }}</td>
                            <td>
                                {{ i.lleno ? '✅' : '❌' }}
                            </td>
                            <td>
                                <button 
                                    :class="expandedRow === i.product_id ? 'btn btn-sm btn-secondary' : 'btn btn-sm btn-primary'"
                                    @click="toggleRow(i.product_id)">
                                    {{ expandedRow === i.product_id ? 'Ocultar' : 'Ver más' }}
                                </button>
                            </td>
                        </tr>

                        <tr v-if="expandedRow === i.product_id" class="border-0 border-top-0">
                            <td colspan="2" class="p-0 border-0">
                                <strong>Producto:</strong> <br>
                                    Codigo: {{ i.product_id }} <br>
                                    Nombre: {{ i.Nombre }} <br>
                                    Marca: {{ i.Marca }}
                            </td>
                            <td colspan="8">
                                <div class="mt-3 p-3" style="background-color: #caf7ffff; border-radius: 15px;">
                                    <h6 class="fw-bold">Detalle Cerezos</h6>
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Código</th>
                                                <th>Nombre</th>
                                                <th>Marca</th>
                                                <th>Lote</th>
                                                <th>Ubicación</th>
                                                <th>Und.MBA</th>
                                                <th>Und.TF</th>
                                                <th>Llenado</th>
                                                <th>Diferencia</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td v-if="detalle_cerezos.length===0" class="text-center" colspan="8">No hay registros...</td>
                                            </tr>
                                            <tr v-for="(d_c, idx) in detalle_cerezos" :key="idx">
                                                <td>{{ d_c.product_id }}</td>
                                                <td>{{ d_c.product_name }}</td>
                                                <td>{{ d_c.group_code }}</td>
                                                <td>{{ d_c.lote_id }}</td>
                                                <td>{{ d_c.ubicacion__bodega }}-{{ d_c.ubicacion__pasillo }}-{{ d_c.ubicacion__modulo }}-{{ d_c.ubicacion__nivel }}</td>
                                                <td class="text-end">{{ formatNumber(d_c.oh2) }}</td>
                                                <td class="text-end">{{ formatNumber(d_c.total_unidades) }}</td>
                                                <td class="text-center"> {{ d_c.llenado ? '✅' : '❌' }}</td>
                                                <td :class="['text-end', d_c.diferencia < 0 ? 'text-danger' : '']">
                                                    {{ d_c.diferencia < 0 ? `(${Math.abs(d_c.diferencia).toLocaleString()})` : d_c.diferencia }}</td>
                                            </tr>
                                            <tr>
                                                <td colspan="5" class="text-end fw-bold">Totales:</td>
                                                <td class="text-end fw-bold">{{ formatNumber(detalle_totales_cerezos.cerezos_mba_total) }}</td>
                                                <td class="text-end fw-bold">{{ formatNumber(detalle_totales_cerezos.cerezos_tf_total) }}</td>
                                                <td :class="['text-end', 'fw-bold', detalle_totales_cerezos.cerezos_diferencia_total < 0 ? 'text-danger' : '']">
                                                    {{ detalle_totales_cerezos.cerezos_diferencia_total < 0 ? `(${Math.abs(detalle_totales_cerezos.cerezos_diferencia_total)})` : detalle_totales_cerezos.cerezos_diferencia_total }}
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </td>
                        </tr>
                        </template>

                        {% endverbatim %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    new Vue({
        el: '#app',
        data: {
            // FILTRO
            filtro: '',
            // STOCK
            actualizandoStock: false,
            stock: [],
            sortField: null,
            sortDirection: 'asc',

            expandedRow: null,
            detalle_cerezos: [],
            detalle_totales_cerezos: {},

            filtroEstado:null
        },
        mounted() {
            this.getStock();
        },
        computed: {
            stockFiltrado() {
                // Paso 1: Aplicar filtro de búsqueda
                let resultadoFiltrado = this.stock.filter(i => {
                    // Usar toString() para manejar getters/setters de Vue
                    const productId = (i.product_id || '').toString().toLowerCase();
                    const productName = (i.Nombre || '').toString().toLowerCase();
                    const marca = (i.Marca || '').toString().toLowerCase();
                    const filtroLower = this.filtro.toLowerCase();
                    
                    return productId.includes(filtroLower) ||
                        productName.includes(filtroLower) ||
                        marca.includes(filtroLower);
                });

                if (this.filtroEstado) {
                    resultadoFiltrado = resultadoFiltrado.filter(i => {
                        // Calcular diferencia si no existe en los datos
                        // const diferencia = i.diferencia || this.calcularDiferencia(i);                        
                        if (this.filtroEstado === 'diferencia0') {
                            return i.diferencia !== 0;
                            // return i.diferencia === 0;
                        } else if (this.filtroEstado === 'lleno') {
                            // Asumiendo que 'lleno' significa que hay stock disponible
                            // Ajusta esta lógica según tus necesidades específicas
                            return i.lleno;
                        }
                        return true;
                    });
                };
                
                // Paso 2: Aplicar ordenamiento si hay un campo seleccionado
                if (!this.sortField) {
                    return resultadoFiltrado;
                }
                
                return resultadoFiltrado.sort((a, b) => {
                    // Acceder a los valores de los objetos reactivos
                    let valorA = a[this.sortField];
                    let valorB = b[this.sortField];
                    
                    // Manejar valores null/undefined
                    if (valorA == null) valorA = '';
                    if (valorB == null) valorB = '';
                    
                    let resultado = 0;
                    
                    // Determinar si el campo es numérico (basado en los datos)
                    const camposNumericos = [
                        'oh2_andagoya', 
                        'total_unidades_andagoya',
                        'oh2_cerezos',
                        'total_unidades_cerezos',
                        'diferencia'
                    ];
                    
                    if (camposNumericos.includes(this.sortField)) {
                        // Ordenamiento para números - convertir explícitamente
                        const numA = this.convertirANumero(valorA);
                        const numB = this.convertirANumero(valorB);
                        resultado = numA - numB;
                    }
                    else if (this.sortField === 'product_id') {
                        // Para product_id, intentamos extraer la parte numérica para ordenar
                        const numA = this.extraerNumeroProducto(valorA);
                        const numB = this.extraerNumeroProducto(valorB);
                        resultado = numA - numB;
                    }
                    else {
                        // Ordenamiento para strings
                        const strA = valorA.toString().toLowerCase();
                        const strB = valorB.toString().toLowerCase();
                        resultado = strA.localeCompare(strB);
                    }
                    
                    // Aplicar dirección del ordenamiento
                    return this.sortDirection === 'asc' ? resultado : -resultado;
                });
            }
        },
        methods: {
            async getStock() {
                this.actualizandoStock = true;
                try {
                    // const response = await fetch('/inventario/resumen_total_unificado');
                    const response = await fetch('/inventario/resumen_cerezos_data');
                    const data = await response.json();
                    console.log('Datos recibidos:', data);
                    this.stock = data.cerezos || [];
                    
                } catch (error) {
                    console.error('Error al obtener datos:', error);
                    // Opcional: mostrar mensaje de error al usuario
                    alert('Error al cargar los datos. Por favor, intente nuevamente.');
                } finally {
                    this.actualizandoStock = false;
                }
            },
            
            toggleRow(product_id) {
                // Si la fila ya está abierta, la cerramos
                this.expandedRow = this.expandedRow === product_id ? null : product_id;
                if (this.expandedRow) {
                    fetch(`/inventario/resumen-total-unificado-cerezos/detalle?product_id=${product_id}`)
                        .then(response => response.json())
                        .then(data => {
                            // console.log('Detalles recibidos:', data);
                            // Aquí puedes asignar los datos recibidos a una propiedad para mostrarlos en la fila expandida
                            this.detalle_cerezos = data.cerezos || []; 
                            this.detalle_totales_cerezos = data.totales || {};
                        })
                        .catch(error => {
                            this.detalle_cerezos = [];
                            this.detalle_cerezos = [];
                            this.detalle_totales_cerezos = {};
                        });

                } else {
                    // Si la fila se cierra, limpiar los detalles
                    this.detalle_cerezos = [];
                    this.detalle_totales_cerezos = {};
                }
            },

            // Función auxiliar para convertir a número
            convertirANumero(valor) {
                if (typeof valor === 'number') return valor;
                if (typeof valor === 'string') {
                    // Eliminar separadores de miles y convertir
                    const limpio = valor.replace(/\./g, '').replace(',', '.');
                    const numero = parseFloat(limpio);
                    return isNaN(numero) ? 0 : numero;
                }
                return 0;
            },

            // Función para extraer número de product_id
            extraerNumeroProducto(productId) {
                if (typeof productId !== 'string') return 0;
                // Buscar secuencia de números en el string
                const matches = productId.match(/\d+/);
                return matches ? parseInt(matches[0]) : 0;
            },

            // Formatear números con separadores de miles
            formatNumber(num) {
                if (num == null || isNaN(num)) return '0';
                return Number(num).toLocaleString('es-ES');
            },

            // Nuevas funciones para el ordenamiento
            ordenarPor(campo) {
                // Si ya está ordenado por este campo, cambiar dirección
                if (this.sortField === campo) {
                    this.sortDirection = this.sortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    // Nuevo campo, ordenar ascendente
                    this.sortField = campo;
                    this.sortDirection = 'asc';
                }
            },

            // Función auxiliar para obtener el ícono de ordenamiento
            getIconoOrden(campo) {
                if (this.sortField !== campo) {
                    return '↕'; // Ícono neutral
                }
                return this.sortDirection === 'asc' ? '↑' : '↓';
            },

            // Función para limpiar el ordenamiento
            limpiarOrden() {
                this.sortField = null;
                this.sortDirection = 'asc';
            },

            // Métodos para los filtros
            aplicarFiltroTodo() {
                this.filtroEstado = null;
            },
            
            aplicarFiltroDiferencia0() {
                this.filtroEstado = 'diferencia0';
            },
            
            aplicarFiltroLlenado() {
                this.filtroEstado = 'lleno';
            }
        }
    });
</script>
{% endblock %}