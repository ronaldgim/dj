{% extends 'base_vue.html' %}
{% block title %}
<title>T.F Andagoya</title>
{% endblock%}

{% block navbar %}
{% include 'inventario/topnavbar.html' %} 
{% endblock %}

{% block body %}

<div id="app">
    {% verbatim %}
    <h5 class="m-4 text-center fw-bold">STOCK BODEGA {{ mi_bodega }} - {{ mi_ubicacion }}</h5>
    <div id="msg"></div>
    <h6 class="text-start"><strong># Total de Items: </strong>{{n_inventario}}</h6>
    <h6 class="text-start"><strong># Items por contabilizar: </strong>{{n_inventario_nollenado}}</h6>
    <h6 class="text-start"><strong># Items contabilizados: </strong>{{n_inventario_llenado}}</h6>
    {% endverbatim %}

    <a class="btn btn-secondary" href="{% url 'inventario_andagoya_home' %}">
        <i class="bi bi-arrow-bar-left"></i> Lista de bodegas
    </a>
    
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#agregarItemForm">
        <i class="bi bi-plus-circle"></i> A√±adir
    </button>

    <div class="col-12 mt-2">
        <input v-model="filtro" placeholder="Buscar..." type="text" class="form-control">
    </div>

    <!-- LISTA -->
    <div class="card mt-2 mb-2">
        <div class="card-body m-0 p-0">
            <div class="container table-responsive">
                <table class="table" style="font-size: small;">
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th scope="col">Invenario</th>
                        </tr>
                    </thead>
                    <tbody id="pedidosbuscar">
                        {% verbatim %}
                        <tr v-for="(i, index) in stockFiltrado" :key="index" :style="{backgroundColor:llenadoColor(i.llenado)}">
                            <td>
                                <label class="fw-bold">C√≥digo:</label> {{i.product_id}} <br>
                                <label class="fw-bold">Nombre:</label> {{i.product_name}}<br>
                                <label class="fw-bold">Marca: </label> {{i.group_code}}<br>
                                <label class="fw-bold">Unidad de Venta:</label> {{i.um}}<br> 
                                <label class="fw-bold">Lote:</label>{{i.lote_id}} <br>
                                <label class="fw-bold">Total Unidades Lote:</label> {{i.total_unidades_ok.toLocaleString()}}<br> 
                            </td>
                            <td>
                                <button @click="getItem(i.id)" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#tomaFisicaForm">
                                    <i class="bi bi-boxes"></i>
                                </button>
                                <button @click="addItemLote(i.product_id)" class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#agregarItemForm">
                                    <i class="bi bi-plus-circle"></i>
                                </button>
                            </td>
                        </tr>
                        {% endverbatim %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- TOMA FISICA -->
    <div class="modal fade" id="tomaFisicaForm" tabindex="-1" aria-labelledby="tomaFisicaFormLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-scrollable">
            <div class="modal-content">
                <input type="hidden" id="user-id" value="{{ request.user.id }}">
                {% verbatim %}
                <div class="modal-header d-flex flex-column align-items-center">
                    <div class="d-flex justify-content-between w-100 align-items-center">
                        <h5 class="modal-title text-center fw-bold" id="tomaFisicaFormLabel">INVENTARIO {{ mi_bodega }} - {{ mi_ubicacion }}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="mt-2 w-100">
                        <div class="card">
                            <div class="card-body">
                                <label class="fw-bold m-0 p-0">C√≥digo:</label> <span>{{item.product_id}}</span><br>
                                <label class="fw-bold m-0 p-0">Nombre:</label> <span>{{item.product_name}}</span><br>
                                <label class="fw-bold m-0 p-0">Marca:</label> <span>{{item.group_code}}</span><br>
                            </div>
                        </div>
                        <!-- div class="card" :style="{backgroundColor:diferenciaColor(diferencia)}"-->
                        <div class="card" :style="{backgroundColor:diferenciaColor()}">

                            <!--h6 class="text-center fw-bold">DIFERENCIA</h6-->
                            <label class="text-center fs-6">T.Lotes - T.Agrupado = Diferencia</label>
                            <div class="fs-6 card-body d-flex justify-content-center align-items-center m-0 p-0">
                                {{ total_lotes.toLocaleString() }} - {{ total_agrupado.toLocaleString() }} = {{ diferencia_calculo }}
                                <!--{{ total_lotes.toLocaleString() }} - {{ total_agrupado.toLocaleString() }} = {{ diferencia.toLocaleString() }} -->
                            </div>
                        </div>
                    </div>
                </div>
            
                <div class="modal-body">                    
                    <!-- TOTAL AGRUPADO -->
                    <div class="card" style="background-color: #e5f9fd;">
                        <div class="card-body">
                            <h6 class="text-center fw-bold">TOTAL AGRUPADO</h6>
                            <div v-if="msg_totales" :class="`alert alert-${type_msg_totales} text-center p-2 m-0`" role="alert" style="font-size: smaller;">
                                {{msg_totales}}
                            </div>
                            <form @submit.prevent="actualizarCrearTotal()">
                                <label>Unidades por cart√≥n:</label>
                                <input class="form-control form-control-sm" v-model="formTotales.unidades_caja_t" type="number" required>
                                <label>N√∫mero total de cartones (cerrados):</label><br>
                                <!--small style="color: gray; font-size:smaller">Este campo puede hacer calulos (+, -)</small> <small style="color: red; font-size:smaller">solo dos n√∫meros</small><br-->
                                <!--input class="form-control form-control-sm" v-model="formTotales.numero_cajas_t" @input="sumarInput(formTotales.numero_cajas_t, 'numero_cajas_t')" required-->
                                
                                <div class="row g-2">
                                    <div class="col-11">
                                        <input class="form-control form-control-sm" v-model="formTotales.numero_cajas_t">
                                    </div>
                                    <div class="col-1">
                                        <button @click="sumarInput(formTotales.numero_cajas_t, 'numero_cajas_t')" class="btn btn-sm btn-success" type="button">
                                            =
                                        </button>
                                    </div>
                                </div>                              
                                <small style="color: gray; font-size:smaller">Este campo puede hacer calulos (+, -)</small> <small style="color: red; font-size:smaller">solo dos n√∫meros</small><br>

                                <label>Unidades sueltas totales:</label>
                                <!--small style="color: gray; font-size:smaller">Este campo puede hacer calulos (+, -)</small> <small style="color: red; font-size:smaller">solo dos n√∫meros</small> <br-->
                                <!--input class="form-control form-control-sm" v-model="formTotales.unidades_sueltas_t" @input="sumarInput(formTotales.unidades_sueltas_t, 'unidades_sueltas_t')" required-->
                                
                                <div class="row g-2">
                                    <div class="col-11">
                                        <input class="form-control form-control-sm" v-model="formTotales.unidades_sueltas_t">
                                    </div>
                                    <div class="col-1">
                                        <button @click="sumarInput(formTotales.unidades_sueltas_t, 'unidades_sueltas_t')" class="btn btn-sm btn-success" type="button">
                                            =
                                        </button>
                                    </div>
                                </div>
                                <small style="color: gray; font-size:smaller">Este campo puede hacer calulos (+, -)</small> <small style="color: red; font-size:smaller">solo dos n√∫meros</small><br>
                                
                                <!--label class="fw-bold">Total Unidades:</label> {{ total_agrupado.toLocaleString() }}<br-->
                                <label class="fw-bold">Total Unidades:</label> {{ total_agrupado_function.toLocaleString() }}<br>
                                <button type="submit" class="btn btn-sm btn-primary float-sm-end mt-2">GUARDAR</button>
                            </form>
                        </div>
                    </div>

                    <hr>

                    <!-- DETALLE LOTES -->
                    <div class="card">
                        <div class="card-body mb-0 pb-0"> 
                            <h6 class="fw-bold text-center">DETALLE DE LOTES</h6> 
                            <table class="table">
                                <thead>
                                    <th>C√≥digo</th>
                                    <th>Lote(s)</th>
                                    <th>Unidades</th>
                                </thead>
                                <tbody>
                                    <tr v-for="(i, index) in lotes">
                                        <td>{{ i.product_id }}</td>
                                        <td>{{ i.lote_id }}</td>
                                        <!-- td class="text-end">{{ i.total_unidades.toLocaleString() }}</td-->
                                        <td class="text-end">{{ i.unidades_ok }}</td>
                                    </tr>
                                    <tr>
                                        <th>TOTAL</th>
                                        <td></td>
                                        <td class="text-end">{{ total_lotes.toLocaleString() }}</td>
                                    </tr>
                                </tbody>
                            </table>               
                        </div>
                    </div>

                    <hr> 

                    <!-- CONTEO POR LOTE -->
                    <div class="card">
                        <div class="card-body">
                            <h6 class="text-center fw-bold">CONTEO POR LOTE</h6> 
                            <div v-if="msg_lote" :class="`alert alert-${type_msg_lote} text-center p-2 m-0`" role="alert" style="font-size: smaller;">
                                {{msg_lote}}
                            </div>

                            <mark><label class="fw-bold m-0 p-0">Lote:</label> {{item.lote_id}}</mark><br>
                            <label class="fw-bold m-0 p-0">F.Elab:</label> {{item.fecha_elab_lote}}<br>
                            <label class="fw-bold m-0 p-0">F.Cadu:</label> {{item.fecha_cadu_lote}}<br>
                            
                            <form @submit.prevent="actualizarItem(formLote.id)">
                                <label>Unidades por cart√≥n:</label>
                                <input class="form-control form-control-sm" v-model="formLote.unidades_caja" type="number" required>
                                
                                <label>N√∫mero total de cartones:</label>
                                <input class="form-control form-control-sm" v-model="formLote.numero_cajas" type="number">
                                
                                <label>Unidades sueltas:</label>
                                <input class="form-control form-control-sm" v-model="formLote.unidades_sueltas" type="number">
                                
                                <!--div class="bg-info p-2 mt-2 mb-2 rounded">
                                <label>Unidades estanteria:</label>
                                <input class="form-control form-control-sm" v-model="formLote.unidades_estanteria" type="number">
                                </div-->

                                <label>Observaciones:</label>
                                <textarea class="form-control form-control-sm" v-model="formLote.observaciones"></textarea>
                                <label class="fw-bold">Total Unidades:</label> {{ conteo_fisico_lote.toLocaleString() }}<br>
                                <button type="submit" class="btn btn-sm btn-primary float-sm-end mt-2">GUARDAR</button>
                            </form>                      
                        </div>
                    </div>
                
                </div>
                {% endverbatim %}
            </div>
        </div>
    </div>

    <!-- AGREGAR ITEM -->
    <div class="modal fade" id="agregarItemForm" tabindex="-1" aria-labelledby="agregarItemFormLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-scrollable">
            <div class="modal-content">
                <input type="hidden" id="user-id" value="{{ request.user.id }}">
                {% verbatim %}
                <div class="modal-header d-flex flex-column align-items-center">
                    <div class="d-flex justify-content-between w-100 align-items-center">
                        <h5 class="modal-title text-center fw-bold" id="agregarItemFormLabel">AGREGAR ITEM {{ mi_bodega }} - {{ mi_ubicacion }}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div v-if="msg_agregar_lote" :class="`alert alert-${type_msg_agregar_lote} text-center p-2 m-0`" role="alert" style="font-size: smaller;">
                        {{msg_agregar_lote}}
                    </div>
                </div>
            
                <div class="modal-body">                    
                    <!-- BUSCAR PRODUCTO -->
                    <div class="card" style="background-color: #e5f9fd;">
                        <div class="card-body">
                            <h6 class="text-center fw-bold">BUSCAR PRODUCTO</h6>
                            <div v-if="msg_product" :class="`alert alert-${type_msg_product} text-center p-2 m-0`" role="alert" style="font-size: smaller;">
                                {{msg_product}}
                            </div>
                            <label>C√≥digo de producto:</label>
                            <v-select @input="buscarProducto()" :options="productList" label="codigo" v-model="formBuscar.product_id" required></v-select>
                        </div>
                    </div>
                    <hr>
                    <!-- AGREGAR ITEM -->
                    <div class="card">
                        <div class="card-body">
                            <h6 class="text-center fw-bold">CONTEO POR LOTE</h6> 
                            <!--div v-if="msg_agregar_lote" :class="`alert alert-${type_msg_agregar_lote} text-center p-2 m-0`" role="alert" style="font-size: smaller;">
                                {{msg_agregar_lote}}
                            </div-->
                            <form @submit.prevent="agregarProducto()" id="form-agregar">
                                
                                <label>C√≥digo:</label>
                                <input class="form-control form-control-sm" v-model="formAgregar.product_id" type="text" required>
                                
                                <label>Nombre:</label>
                                <input class="form-control form-control-sm" v-model="formAgregar.product_name" type="text" required>
                                
                                <label>Marca:</label>
                                <input class="form-control form-control-sm" v-model="formAgregar.group_code" type="text" required>
                                
                                <!--label>Presentaci√≥n:</label>
                                <input class="form-control form-control-sm" v-model="formAgregar.um" type="text" required-->

                                <label>Lote:</label>
                                <div class="row g-2">
                                    <div class="col-11">
                                        <select @change="getFechas" v-show="lote_input" class="form-select form-select-sm" v-model="formAgregar.lote_id" style="width: 100%;">
                                            <option v-for="i in listaLotesAgregar" :key="listaLotesAgregar.id">{{ i.lote_id }}</option>
                                        </select>
                                        <input v-show="!lote_input" class="form-control form-control-sm" v-model="formAgregar.lote_id" type="text" required>
                                    </div>
                                    <div class="col-1">
                                        <!--button @click="lote_input_toggle" class="btn btn-sm btn-secondary" type="button"-->
                                        <button @click="lote_input_toggle" :class="lote_input ? 'btn btn-sm btn-secondary' : 'btn btn-sm btn-info'" type="button">
                                            <i class="bi bi-pencil-square"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Fecha elaboraci√≥n -->
                                <label>Fecha elaboraci√≥n:</label>
                                <input type="checkbox" v-model="mes_anio_felab"> Mes/A√±o
                                <input
                                    class="form-control form-control-sm"
                                    v-model="formAgregar.fecha_elab_lote"
                                    type="text"
                                    @input="formatoFecha('fecha_elab_lote', mes_anio_felab)"
                                    pattern="\d{2}/\d{2}/\d{4}"
                                    maxlength="10"
                                    :placeholder="mes_anio_felab ? 'mm/aaaa' : 'dd/mm/aaaa'"
                                    required
                                >
                                <p v-if="mes_anio_felab_msg" style="color:red; font-size:smaller;">
                                    {{ mes_anio_felab_msg }}
                                </p>
                                <p v-else-if="!validDateInputs.fecha_elab_lote" style="color:red; font-size:smaller;">
                                    Formato inv√°lido ({{ mes_anio_felab ? 'mm/aaaa' : 'dd/mm/aaaa' }})
                                </p>

                                <!-- Fecha caducidad -->
                                <label>Fecha caducidad:</label>
                                <input type="checkbox" v-model="mes_anio_fcadu"> Mes/A√±o
                                <input
                                    class="form-control form-control-sm"
                                    v-model="formAgregar.fecha_cadu_lote"
                                    type="text"
                                    @input="formatoFecha('fecha_cadu_lote', mes_anio_fcadu)"
                                    pattern="\d{2}/\d{2}/\d{4}"
                                    maxlength="10"
                                    :placeholder="mes_anio_fcadu ? 'mm/aaaa' : 'dd/mm/aaaa'"
                                    required
                                >
                                <p v-if="mes_anio_fcadu_msg" style="color:red; font-size:smaller;">
                                    {{ mes_anio_fcadu_msg }}
                                </p>
                                <p v-else-if="!validDateInputs.fecha_cadu_lote" style="color:red; font-size:smaller;">
                                    Formato inv√°lido ({{ mes_anio_fcadu ? 'mm/aaaa' : 'dd/mm/aaaa' }})
                                </p>


                                <label>Unidades por cart√≥n:</label>
                                <input class="form-control form-control-sm" v-model="formAgregar.unidades_caja" type="number" required>

                                <label>N√∫mero total de cartones:</label>
                                <input class="form-control form-control-sm" v-model="formAgregar.numero_cajas" type="number">

                                <label>Unidades sueltas:</label>
                                <input class="form-control form-control-sm" v-model="formAgregar.unidades_sueltas" type="number">

                                <!--div class="bg-info p-2 mt-2 mb-2 rounded">
                                <label>Unidades estanteria:</label>
                                <input class="form-control form-control-sm" v-model="formAgregar.unidades_estanteria" type="number">
                                </div-->

                                <label>Observaciones:</label>
                                <textarea class="form-control form-control-sm" v-model="formAgregar.observaciones"></textarea>

                                <label class="fw-bold">Total Unidades:</label> {{ conteo_fisico_agregar_lote.toLocaleString() }}<br>
                                <button type="reset" class="btn btn-sm btn-secondary float-sm-end mt-2 ms-2 me-2">BOORAR</button>
                                <!--button type="submit" class="btn btn-sm btn-primary float-sm-end mt-2">GUARDAR</button  :disabled="agregando" -->
                                <button
                                    type="submit"
                                    class="btn btn-sm btn-primary float-sm-end mt-2"
                                    :disabled="(conteo_fisico_agregar_lote === 0) | agregando"
                                    >
                                    {{ agregando ? 'GUARDANDO...' : 'GUARDAR' }}
                                </button>
                            </form>                      
                        </div>
                    </div>
                </div>
                {% endverbatim %}
            </div>
        </div>
    </div>
</div>

<script>
    Vue.component("v-select", VueSelect.VueSelect);
    new Vue({
        el: '#app',
        data: {
            // LISTADO
            mi_bodega:'',
            mi_ubicacion:'',
            n_inventario:'',
            n_inventario_nollenado:'',
            n_inventario_llenado:'',
            filtro:'',
            stock:[],

            // ITEM
            item:'',

            // TOTALES
            type_msg_totales:'',
            msg_totales:'',
            formTotales:{
                product_id_t:'',
                ware_code_t:'',
                location_t:'',
                unidades_caja_t:'',
                numero_cajas_t:'',
                unidades_sueltas_t:'',
                user_id: Number(document.getElementById("user-id").value)
            },
            total_agrupado:'',
            diferencia:'',

            // LOTES
            lotes:[],
            total_lotes:'',
            
            // CONTEO LOTE
            type_msg_lote:'',
            msg_lote:'',
            formLote:{
                unidades_caja:'',
                numero_cajas:'',
                unidades_sueltas:'',
                unidades_estanteria:'',
                observaciones:'',
                llenado:true,
                user_id: Number(document.getElementById("user-id").value)
            },
            
            // AGREGAR ITEM
            type_msg_product:'',
            msg_product:'',
            formBuscar:{
                product_id:'',
            },
            listaLotesAgregar:[],
            productList:[],

            // input date
            rawDate:'',
            //formattedDate: '',
            validDateInputs: {
                fecha_elab_lote: true,
                fecha_cadu_lote: true,
            },

            type_msg_agregar_lote:'',
            msg_agregar_lote:'',

            lote_input:true,
            // form agregar
            agregando: false,
            formAgregar:{
                product_id:'',
                product_name:'',
                group_code:'',
                um:'',

                oh:0,
                oh2:0,
                commited:0,
                quantity:0,

                lote_id:'',
                fecha_elab_lote:'',
                fecha_cadu_lote:'',
                ware_code:'',
                location:'',
                unidades_caja:'',
                numero_cajas:'',
                unidades_sueltas:'',
                unidades_estanteria:'',
                observaciones:'',
                llenado:true,
                llenado_estanteria:false,
                agregado:true,
                user_id: Number(document.getElementById("user-id").value)
            },
            
            mes_anio_felab:false,
            mes_anio_fcadu:false,
            mes_anio_felab_msg:"",
            mes_anio_fcadu_msg:"",
        },
        mounted() {
            this.getStock();
            this.getProductoList();
        },
        computed: {
            total_agrupado_function() {
                const u_cajas_t = this.formTotales.unidades_caja_t ? this.formTotales.unidades_caja_t : 0;
                const n_cajas_t = this.formTotales.numero_cajas_t ? this.formTotales.numero_cajas_t : 0;
                const u_sueltas_t = this.formTotales.unidades_sueltas_t ? this.formTotales.unidades_sueltas_t : 0;
                return Number(u_cajas_t * n_cajas_t) + Number(u_sueltas_t)
            },

            conteo_fisico_lote() {
                const u_cajas = this.formLote.unidades_caja ? this.formLote.unidades_caja : 0;
                const n_cajas = this.formLote.numero_cajas ? this.formLote.numero_cajas : 0;
                const u_sueltas = this.formLote.unidades_sueltas ? this.formLote.unidades_sueltas : 0;
                // const u_estanteria = this.formLote.unidades_estanteria ? this.formLote.unidades_estanteria : 0;
                return Number(u_cajas * n_cajas) + Number(u_sueltas) // + Number(u_estanteria)
            },

            conteo_fisico_agregar_lote() {
                const u_cajas = this.formAgregar.unidades_caja ? this.formAgregar.unidades_caja : 0;
                const n_cajas = this.formAgregar.numero_cajas ? this.formAgregar.numero_cajas : 0;
                const u_sueltas = this.formAgregar.unidades_sueltas ? this.formAgregar.unidades_sueltas : 0;
                const u_estanteria = this.formAgregar.unidades_estanteria ? this.formAgregar.unidades_estanteria : 0;
                return Number(u_cajas * n_cajas) + Number(u_sueltas) // + Number(u_estanteria)
            },

            //diferencia() {
            //    const t_lotes = this.total_lotes ? this.total_lotes : 0;
            //    const t_agrupado = this.total_agrupado ? this.total_agrupado : 0;
            //    // const t_unidades_estanteria = this.unidades_estanteria ? this.unidades_estanteria : 0;
            //    return Number(t_lotes - t_agrupado) // - t_unidades_estanteria)
            //},
            
            diferencia_calculo(){
                const t_lotes = this.total_lotes ? this.total_lotes : 0;
                const t_agrupado = this.total_agrupado ? this.total_agrupado : 0;
                return this.diferencia = Number(t_lotes - t_agrupado);
                // return Number(t_lotes - t_agrupado);
            },

            stockFiltrado() {
                return this.stock.filter(i =>
                    i.product_id.toLowerCase().includes(this.filtro.toLowerCase()) ||
                    i.product_name.toLowerCase().includes(this.filtro.toLowerCase()) ||
                    i.group_code.toLowerCase().includes(this.filtro.toLowerCase()) ||
                    i.lote_id.toLowerCase().includes(this.filtro.toLowerCase())
                )
            }
        },
        methods: {
            llenadoColor(llenado) {
                switch (llenado) {
                    case true:
                        return '#BAF690';
                }
            },

            // diferencia_calculo(){
            //     const t_lotes = this.total_lotes ? this.total_lotes : 0;
            //     const t_agrupado = this.total_agrupado ? this.total_agrupado : 0;
            //     return this.diferencia = Number(t_lotes - t_agrupado);
            //     // return Number(t_lotes - t_agrupado);
            // },

            diferenciaColor(){
                const t_lotes = this.total_lotes ? this.total_lotes : 0;
                const t_agrupado = this.total_agrupado ? this.total_agrupado : 0;
                // const t_unidades_estanteria = this.unidades_estanteria ? this.unidades_estanteria : 0;
                const diferencia = Number(t_lotes - t_agrupado);

                if (diferencia === 0) {
                    return '#BAF690';
                } else {
                    return '#F6B690';
                }
            },

            sumarInput(input, name) {

                if (input.includes('+')) {
                    let array = input.split('+');
                    let n_uno = array[0];
                    let n_dos = array[1];
                    if (n_dos) {
                        let total = Number(n_uno) + Number(n_dos);
                        this.formTotales[name] = Number(total);
                    }
                } else if (input.includes('-')) {
                    let array = input.split('-');
                    
                    let n_uno = array[0];
                    let n_dos = array[1];
                    if (n_dos) {
                        let total = Number(n_uno) - Number(n_dos);
                        this.formTotales[name] = Number(total);
                    }
                }
            },

            formatoFecha(name, esMesAnio = false) {
                let valor = this.formAgregar[name] || "";
                let rawDate = valor.replace(/\D/g, ""); // solo n√∫meros
                let formatted = "";

                // Reiniciar mensajes si se escribe o borra
                if (name === "fecha_elab_lote") this.mes_anio_felab_msg = "";
                if (name === "fecha_cadu_lote") this.mes_anio_fcadu_msg = "";

                // üëâ Si el usuario est√° borrando todo, limpiamos y salimos
                if (valor === "" || rawDate.length === 0) {
                    this.formAgregar[name] = "";
                    this.validDateInputs[name] = false;
                    return;
                }

                if (esMesAnio) {
                    // ---- FORMATO MES/A√ëO ----
                    if (rawDate.length >= 1) {
                    formatted = rawDate.substring(0, 2);
                    }
                    if (rawDate.length >= 3) {
                    formatted += "/" + rawDate.substring(2, 6);
                    }

                    // Validar mes (01‚Äì12)
                    if (rawDate.length >= 2) {
                    const month = parseInt(rawDate.substring(0, 2), 10);
                    if (!isNaN(month) && (month < 1 || month > 12)) {
                        const msg = "‚ùå El mes ingresado no es v√°lido. Debe ser entre 01 y 12.";
                        if (name === "fecha_elab_lote") this.mes_anio_felab_msg = msg;
                        if (name === "fecha_cadu_lote") this.mes_anio_fcadu_msg = msg;
                        this.formAgregar[name] = "";
                        this.validDateInputs[name] = false;
                        return;
                    }
                    }

                    // Completar fecha solo cuando ya se escribi√≥ mm/yyyy
                    if (rawDate.length >= 6) {
                    const mes = rawDate.substring(0, 2);
                    const anio = rawDate.substring(2, 6);
                    const month = parseInt(mes, 10);
                    const year = parseInt(anio, 10);

                    if (!isNaN(month) && !isNaN(year) && month >= 1 && month <= 12) {
                        if (name === "fecha_elab_lote") {
                        // D√≠a 01 del mes
                        this.formAgregar[name] = `01/${mes}/${anio}`;
                        } else if (name === "fecha_cadu_lote") {
                        // √öltimo d√≠a del mes
                        const lastDay = new Date(year, month, 0).getDate();
                        this.formAgregar[name] = `${String(lastDay).padStart(2, "0")}/${mes}/${anio}`;
                        }
                        this.validDateInputs[name] = true;
                    } else {
                        this.validDateInputs[name] = false;
                    }
                    } else {
                    this.formAgregar[name] = formatted;
                    this.validDateInputs[name] = false;
                    }
                    
                } else {
                    // ---- FORMATO D√çA/MES/A√ëO ----
                    if (rawDate.length > 0) {
                    formatted = rawDate.substring(0, 2);
                    }

                    if (rawDate.length >= 3) {
                    formatted += "/" + rawDate.substring(2, 4);
                    }

                    if (rawDate.length >= 5) {
                    const month = parseInt(rawDate.substring(2, 4), 10);
                    if (isNaN(month) || month < 1 || month > 12) {
                        const msg = "‚ùå El mes ingresado no es v√°lido. Debe ser entre 01 y 12.";
                        if (name === "fecha_elab_lote") this.mes_anio_felab_msg = msg;
                        if (name === "fecha_cadu_lote") this.mes_anio_fcadu_msg = msg;
                        this.formAgregar[name] = rawDate.substring(0, 2);
                        this.validDateInputs[name] = false;
                        return;
                    }
                    formatted += "/" + rawDate.substring(4, 8);
                    }

                    if (formatted.endsWith("/")) {
                    formatted = formatted.slice(0, -1);
                    }

                    this.formAgregar[name] = formatted;

                    const regex = /^\d{2}\/\d{2}\/\d{4}$/;
                    this.validDateInputs[name] = regex.test(formatted);
                    
                }
            },

            esFormularioValido() {
                // Verifica si todos los campos son v√°lidos
                return Object.values(this.validDateInputs).every((isValid) => isValid);
            },

            lote_input_toggle() {
                this.lote_input = !this.lote_input
            },

            getFechas(event) {
                console.log('ejecutando...');
                const loteSelected = event.target.value;
                let fechas = this.listaLotesAgregar.filter(i=>i.lote_id === loteSelected)[0]
                
                this.formAgregar.fecha_elab_lote = fechas.fecha_elab_lote.split('-')[2] + '/' + fechas.fecha_elab_lote.split('-')[1] + '/' + fechas.fecha_elab_lote.split('-')[0];
                this.formAgregar.fecha_cadu_lote = fechas.fecha_cadu_lote.split('-')[2] + '/' + fechas.fecha_cadu_lote.split('-')[1] + '/' + fechas.fecha_cadu_lote.split('-')[0];
            },

            async getStock () {
                const url = window.location.href;
                const params = url.split('/');
                const bodega = params[5];
                const my_location = params[6];
                try {
                    const response = await fetch(`/inventario/inv/${bodega}/${my_location}`);
                    const data = await response.json();
                    this.mi_bodega = data.mi_bodega;
                    this.mi_ubicacion = data.mi_ubicacion;
                    this.n_inventario = data.n_inventario;
                    this.n_inventario_nollenado = data.n_inventario_nollenado;
                    this.n_inventario_llenado = data.n_inventario_llenado;
                    this.stock = data.inventario || [];
                } catch (error) {
                    console.log(error);
                }
            },

            async getItem(item_id) {
                
                try {
                    const response = await fetch(`/inventario/toma-fisica/${item_id}`);
                    const data = await response.json();
                    
                    // Item
                    this.item = data.item;

                    // List de lotes
                    // this.lotes = this.stock.filter(i => 
                    //     i.product_id == this.item.product_id &&
                    //     i.ware_code == this.item.ware_code &&
                    //     i.location == this.item.location);
                    
                    // // Total lotes
                    // this.total_lotes = this.lotes.reduce((acumulador, unidades) => acumulador + unidades.total_unidades, 0)

                    // lotes
                    this.lotes = data.lotes;
                    this.total_lotes = data.total_lotes;
                    this.total_agrupado = data.total_agrupado;
                    this.diferencia = data.diferencia;

                    // Form totales
                    if (data.item_totales){
                        this.formTotales.id = data.item_totales.id;
                        this.formTotales.product_id_t = data.item_totales.product_id_t;
                        this.formTotales.ware_code_t = data.item_totales.ware_code_t;
                        this.formTotales.location_t = data.item_totales.location_t;
                        this.formTotales.unidades_caja_t = data.item_totales.unidades_caja_t;
                        this.formTotales.numero_cajas_t = (data.item_totales.numero_cajas_t === 0) ? '' : data.item_totales.numero_cajas_t;
                        this.formTotales.unidades_sueltas_t = (data.item_totales.unidades_sueltas_t === 0) ? '' : data.item_totales.unidades_sueltas_t;
                        
                    } 
                    else {
                        this.formTotales.id = null;  
                        this.formTotales.product_id_t = data.item.product_id;
                        this.formTotales.ware_code_t = data.item.ware_code;
                        this.formTotales.location_t = data.item.location;
                        this.formTotales.unidades_caja_t = data.item.unidades_caja;
                        this.formTotales.numero_cajas_t = '';
                        this.formTotales.unidades_sueltas_t = '';
                    }
                    
                    // Form lote 
                    this.formLote.id = data.item.id;
                    this.formLote.unidades_caja = data.item.unidades_caja;
                    this.formLote.numero_cajas = (!data.item.llenado && data.item.numero_cajas === 0) ? '' : data.item.numero_cajas;
                    this.formLote.unidades_sueltas = (!data.item.llenado && data.item.unidades_sueltas === 0) ? '' :data.item.unidades_sueltas;
                    this.formLote.unidades_estanteria = (!data.item.llenado && data.item.unidades_estanteria === 0) ? '' :data.item.unidades_estanteria;

                    setTimeout(
                        () => {
                            this.msg_lote = '';
                            this.msg_totales = '';
                        }, 1000)
                } catch (error) {
                    console.error(error);
                }
            },

            async actualizarCrearTotal() {
                try {
                    const response = await fetch('/inventario/toma-fisica/total-agrupado', { 
                        method: 'POST',
                        headers: {'Content-Type': 'application/json',},
                        body: JSON.stringify(this.formTotales)
                    });
                    const data = await response.json();
                    this.type_msg_totales = data.type;
                    this.msg_totales = data.msg;
                    this.total_agrupado = data.unidades;
                } catch (error) {
                    this.msg_totales = error;
                    this.type_msg_totales = 'danger';
                }
            },
            
            async actualizarItem(item_id) {
                try {
                    const response = await fetch(`/inventario/toma-fisica/${item_id}`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json',},
                        body: JSON.stringify(this.formLote)
                    });
                    const data = await response.json();
                    this.type_msg_lote = data.type;
                    this.msg_lote = data.msg; 

                    await this.getStock();
                    await this.getItem(item_id);     
                    
                } catch (error) {
                    this.type_msg_lote = 'danger';
                    this.type_msg_item = error;
                }
            },

            async buscarProducto() {

                if (!this.formBuscar.product_id) {
                    return
                }

                try {
                    const response = await fetch('/inventario/toma-fisica/buscar-producto', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(this.formBuscar)
                    });
                    const data = await response.json();
                    
                    // Msg product
                    this.type_msg_product = data.type;
                    this.msg_product = data.msg;

                    // Form Agregar
                    if (data.product) {
                        this.formAgregar.product_id = data.product.product_id;
                        this.formAgregar.product_name = data.product.Nombre;
                        this.formAgregar.group_code = data.product.Marca;
                        this.formAgregar.um = data.product.Unidad;
                        this.formAgregar.ware_code = this.mi_bodega;
                        this.formAgregar.location = this.mi_ubicacion;
                        this.formAgregar.unidades_caja = data.product.Unidad_Empaque;

                        // agregar lista de lotes
                        this.listaLotesAgregar = data.data_lotes || [];
                    } 
                    else {
                        this.formAgregar.product_id = '';
                        this.formAgregar.product_name = '';
                        this.formAgregar.group_code = '';
                        this.formAgregar.um = '';
                        this.formAgregar.unidades_caja = '';
                        this.listaLotesAgregar = [];
                    }
                } catch (error) {
                    this.type_msg_product = 'danger';
                    this.msg_product = error;
                }
            },

            async agregarProducto() {
                this.agregando = true;
                try {
                    const response = await fetch('/inventario/toma-fisica/agregar-producto', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(this.formAgregar)
                    }); 
                    const data = await response.json();
                    this.type_msg_agregar_lote = data.type;
                    this.msg_agregar_lote = data.msg;

                    // set form buscarProducto
                    this.formBuscar.product_id = '';
                    this.type_msg_product='',
                    this.msg_product='';

                    // reset form
                    this.formAgregar.product_id = '';
                    this.formAgregar.product_name = '';
                    this.formAgregar.group_code = '';
                    this.formAgregar.um = '';

                    this.formAgregar.oh = 0;
                    this.formAgregar.oh2 = 0;
                    this.formAgregar.commited = 0;
                    this.formAgregar.quantity = 0;

                    this.formAgregar.lote_id = '';
                    this.formAgregar.fecha_elab_lote = '';
                    this.formAgregar.fecha_cadu_lote = '';
                    this.formAgregar.ware_code = '';
                    this.formAgregar.location = '';
                    this.formAgregar.unidades_caja = '';
                    this.formAgregar.numero_cajas = '';
                    this.formAgregar.unidades_sueltas = '';
                    this.formAgregar.observaciones = '';
                    
                    this.formAgregar.lotes = [];

                    this.mes_anio_felab = false,
                    this.mes_anio_felab_msg = "",
                    this.mes_anio_fcadu = false,
                    this.mes_anio_fcadu_msg = "",
                    this.agregando = false
                    await this.getStock();
                    setTimeout(
                        () => {
                            this.msg_agregar_lote = '';
                        }, 2000)
                        
                } catch (error) {
                    this.type_msg_agregar_lote = 'danger';
                    this.msg_agregar_lote = error;
                } finally {
                    this.agregando = false
                }
            },

            async getProductoList(){
                try {
                    const res = await fetch('/api/warehouse-productos-list');
                    const data = await res.json();
                    this.productList = data.data || [];
                } catch (error) {
                    console.log(error)
                }
            },
            onSelectChange(event) {
                this.formBuscar.product_id = event.target.value;
            },
            addItemLote(product_id) {
                this.formBuscar.product_id = {codigo: product_id};
                this.buscarProducto();
            }
        }
    })
</script>
{% endblock %}