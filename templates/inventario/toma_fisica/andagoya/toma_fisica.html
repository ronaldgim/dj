{% extends 'base_vue.html' %}
{% block title %}
<title>T.F Andagoya</title>
{% endblock%}

{% block navbar %}
{% include 'inventario/topnavbar.html' %} 
{% endblock %}

{% block body %}

<div id="app">
    {% verbatim %}
    <h5 class="m-4 text-center fw-bold">STOCK BODEGA {{ mi_bodega }} - {{ mi_ubicacion }}</h5>
    <div id="msg"></div>
    <h6 class="text-start"><strong># Total de Items: </strong>{{n_inventario}}</h6>
    <h6 class="text-start"><strong># Items por contabilizar: </strong>{{n_inventario_nollenado}}</h6>
    <h6 class="text-start"><strong># Items contabilizados: </strong>{{n_inventario_llenado}}</h6>
    {% endverbatim %}


    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#agregarItemForm">
        <i class="bi bi-plus-circle"></i> Añadir
    </button>

    <div class="col-12 mt-2">
        <input id="inputbuscar" type="text" placeholder="Buscar" class="form-control">
    </div>

    <!-- Lista -->
    <div class="card mt-2 mb-2">
        <div class="card-body m-0 p-0">
            <div class="container table-responsive">
                <table class="table" style="font-size: small;">
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th scope="col">Invenario</th>
                        </tr>
                    </thead>
                    <tbody id="pedidosbuscar">
                        {% verbatim %}
                        <tr v-for="(i, index) in stock" :style="{backgroundColor:llenadoColor(i.llenado)}">
                            <td>
                                <label class="fw-bold">Código:</label> {{i.product_id}} <br>
                                <label class="fw-bold">Nombre:</label> {{i.product_name}}<br>
                                <label class="fw-bold">Marca: </label> {{i.group_code}}<br>
                                <label class="fw-bold">Unidad de Venta:</label> {{i.um}}<br> 
                                <label class="fw-bold">Lote:</label>{{i.lote_id}} <br>
                                <label class="fw-bold">Total Unidades Lote:</label> {{i.total_unidades}}<br> 
                            </td>
                            <td>
                                <button @click="getItem(i.id)" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#tomaFisicaForm">
                                    <i class="bi bi-boxes"></i>
                                </button>
                            </td>
                        </tr>
                        {% endverbatim %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- TOMA FISICA -->
    <div class="modal fade" id="tomaFisicaForm" tabindex="-1" aria-labelledby="tomaFisicaFormLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-scrollable">
            <div class="modal-content">
                <input type="hidden" id="user-id" value="{{ request.user.id }}">
                {% verbatim %}
                <div class="modal-header d-flex flex-column align-items-center">
                    <div class="d-flex justify-content-between w-100 align-items-center">
                        <h5 class="modal-title text-center fw-bold" id="tomaFisicaFormLabel">INVENTARIO {{ mi_bodega }} - {{ mi_ubicacion }}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="mt-2 w-100">
                        <div class="card">
                            <div class="card-body">
                                <label class="fw-bold m-0 p-0">Código:</label> {{item.product_id}}<br>
                                <label class="fw-bold m-0 p-0">Nombre:</label> {{item.product_name}}<br>
                                <label class="fw-bold m-0 p-0">Marca:</label> {{item.group_code}}<br>
                            </div>
                        </div>
                    </div>
                </div>
            
                <div class="modal-body">                    
                    <!-- TOTAL AGRUPADO -->
                    <div class="card" style="background-color: #e5f9fd;">
                        <div class="card-body">
                            <h6 class="text-center fw-bold">TOTAL AGRUPADO</h6>
                            <div v-if="msg_totales" :class="`alert alert-${type_msg_totales} text-center p-2 m-0`" role="alert" style="font-size: smaller;">
                                {{msg_totales}}
                            </div>
                            <form @submit.prevent="actualizarCrearTotal()">
                                <label>Unidades por cartón:</label>
                                <input class="form-control form-control-sm" v-model="formTotales.unidades_caja_t" type="number" required>
                                <label>Número de cartones totales:</label><br>
                                <small style="color: gray;">Este campo puede hacer calulos (+, -)</small><br>
                                <!--input class="form-control form-control-sm" v-model="formTotales.numero_cajas_t" v-on:input="sumarInput()" type="number"-->
                                <input class="form-control form-control-sm" v-model="formTotales.numero_cajas_t" @input="sumarInput(formTotales.numero_cajas_t, 'numero_cajas_t')" required>
                                
                                <label>Unidades sueltas totales:</label><br>
                                <small style="color: gray;">Este campo puede hacer calulos (+, -)</small><br>
                                <input class="form-control form-control-sm" v-model="formTotales.unidades_sueltas_t" @input="sumarInput(formTotales.unidades_sueltas_t, 'unidades_sueltas_t')" required>
                                <label class="fw-bold">Total Unidades:</label> {{ total_agrupado }}<br>
                                <button type="submit" class="btn btn-sm btn-primary float-sm-end mt-2">GUARDAR</button>
                            </form>
                        </div>
                    </div>

                    <hr>

                    <!-- DETALLE LOTES -->
                    <div class="card">
                        <div class="card-body mb-0 pb-0"> 
                            <h6 class="fw-bold text-center">DETALLE DE LOTES</h6> 
                            <table class="table">
                                <thead>
                                    <th>Código</th>
                                    <th>Lote(s)</th>
                                    <th>Unidades</th>
                                </thead>
                                <tbody>
                                    <tr v-for="(i, index) in lotes">
                                        <td>{{ i.product_id }}</td>
                                        <td>{{ i.lote_id }}</td>
                                        <td class="text-end">{{ i.total_unidades }}</td>
                                    </tr>
                                    <tr>
                                        <th>TOTAL</th>
                                        <td></td>
                                        <td class="text-end">{{ total_lotes }}</td>
                                    </tr>
                                </tbody>
                            </table>               
                        </div>
                    </div>

                    <hr>
                    <!-- DIFERENCIA -->
                    <div class="card" :style="{backgroundColor:diferenciaColor(diferencia)}">
                        <h6 class="text-center fw-bold">DIFERENCIA</h6>
                        <label class="text-center fs-6">T.Lotes - T.Agrupado = Diferencia</label>
                        <div class="fs-1 card-body d-flex justify-content-center align-items-center m-0 p-0">
                            {{ total_lotes }} - {{ total_agrupado }} = {{ diferencia }}
                        </div>
                    </div>

                    <hr>

                    <!-- CONTEO POR LOTE -->
                    <div class="card">
                        <div class="card-body">
                            <h6 class="text-center fw-bold">CONTEO POR LOTE</h6> 
                            <div v-if="msg_lote" :class="`alert alert-${type_msg_lote} text-center p-2 m-0`" role="alert" style="font-size: smaller;">
                                {{msg_lote}}
                            </div>
                            <mark><label class="fw-bold m-0 p-0">Lote:</label> {{item.lote_id}}</mark><br>
                            <label class="fw-bold m-0 p-0">F.Elab:</label> {{item.fecha_elab_lote}}<br>
                            <label class="fw-bold m-0 p-0">F.Cadu:</label> {{item.fecha_cadu_lote}}<br>
                            <form @submit.prevent="actualizarItem(formLote.id)">
                                <label>Unidades por cartón:</label>
                                <input class="form-control form-control-sm" v-model="formLote.unidades_caja" type="number">
                                <label>Número de cartones totales:</label>
                                <input class="form-control form-control-sm" v-model="formLote.numero_cajas" type="number">
                                <label>Unidades sueltas totales:</label>
                                <input class="form-control form-control-sm" v-model="formLote.unidades_sueltas" type="number">
                                <label>Observaciones:</label>
                                <textarea class="form-control form-control-sm" v-model="formLote.observaciones"></textarea>
                                <label class="fw-bold">Total Unidades:</label> {{ conteo_fisico_lote }}<br>
                                <button type="submit" class="btn btn-sm btn-primary float-sm-end mt-2">GUARDAR</button>
                            </form>                      
                        </div>
                    </div>
                
                </div>
                {% endverbatim %}
            </div>
        </div>
    </div>

    <!-- AGREGAR ITEM -->
    <div class="modal fade" id="agregarItemForm" tabindex="-1" aria-labelledby="agregarItemFormLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-scrollable">
            <div class="modal-content">
                <input type="hidden" id="user-id" value="{{ request.user.id }}">
                {% verbatim %}
                <div class="modal-header d-flex flex-column align-items-center">
                    <div class="d-flex justify-content-between w-100 align-items-center">
                        <h5 class="modal-title text-center fw-bold" id="agregarItemFormLabel">AGREGAR ITEM {{ mi_bodega }} - {{ mi_ubicacion }}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="mt-2 w-100">
                        <div class="card">
                            <div class="card-body">
                                <label class="fw-bold m-0 p-0">Código:</label> {{item.product_id}}<br>
                                <label class="fw-bold m-0 p-0">Nombre:</label> {{item.product_name}}<br>
                                <label class="fw-bold m-0 p-0">Marca:</label> {{item.group_code}}<br>
                            </div>
                        </div>
                    </div>
                </div>
            
                <div class="modal-body">                    
                    <!-- TOTAL AGRUPADO -->
                    <div class="card" style="background-color: #e5f9fd;">
                        <div class="card-body">
                            <h6 class="text-center fw-bold">TOTAL AGRUPADO</h6>
                            <div v-if="msg_totales" :class="`alert alert-${type_msg_totales} text-center p-2 m-0`" role="alert" style="font-size: smaller;">
                                {{msg_totales}}
                            </div>
                            <form @submit.prevent="actualizarCrearTotal()">
                                <label>Unidades por cartón:</label>
                                <input class="form-control form-control-sm" v-model="formTotales.unidades_caja_t" type="number" required>
                                <label>Número de cartones totales:</label><br>
                                <small style="color: gray;">Este campo puede hacer calulos (+, -)</small><br>
                                <!--input class="form-control form-control-sm" v-model="formTotales.numero_cajas_t" v-on:input="sumarInput()" type="number"-->
                                <input class="form-control form-control-sm" v-model="formTotales.numero_cajas_t" @input="sumarInput(formTotales.numero_cajas_t, 'numero_cajas_t')" required>
                                
                                <label>Unidades sueltas totales:</label><br>
                                <small style="color: gray;">Este campo puede hacer calulos (+, -)</small><br>
                                <input class="form-control form-control-sm" v-model="formTotales.unidades_sueltas_t" @input="sumarInput(formTotales.unidades_sueltas_t, 'unidades_sueltas_t')" required>
                                <label class="fw-bold">Total Unidades:</label> {{ total_agrupado }}<br>
                                <button type="submit" class="btn btn-sm btn-primary float-sm-end mt-2">GUARDAR</button>
                            </form>
                        </div>
                    </div>

                    <hr>

                    <!-- DETALLE LOTES -->
                    <div class="card">
                        <div class="card-body mb-0 pb-0"> 
                            <h6 class="fw-bold text-center">DETALLE DE LOTES</h6> 
                            <table class="table">
                                <thead>
                                    <th>Código</th>
                                    <th>Lote(s)</th>
                                    <th>Unidades</th>
                                </thead>
                                <tbody>
                                    <tr v-for="(i, index) in lotes">
                                        <td>{{ i.product_id }}</td>
                                        <td>{{ i.lote_id }}</td>
                                        <td class="text-end">{{ i.total_unidades }}</td>
                                    </tr>
                                    <tr>
                                        <th>TOTAL</th>
                                        <td></td>
                                        <td class="text-end">{{ total_lotes }}</td>
                                    </tr>
                                </tbody>
                            </table>               
                        </div>
                    </div>

                    <hr>
                    <!-- DIFERENCIA -->
                    <div class="card" :style="{backgroundColor:diferenciaColor(diferencia)}">
                        <h6 class="text-center fw-bold">DIFERENCIA</h6>
                        <label class="text-center fs-6">T.Lotes - T.Agrupado = Diferencia</label>
                        <div class="fs-1 card-body d-flex justify-content-center align-items-center m-0 p-0">
                            {{ total_lotes }} - {{ total_agrupado }} = {{ diferencia }}
                        </div>
                    </div>

                    <hr>

                    <!-- CONTEO POR LOTE -->
                    <div class="card">
                        <div class="card-body">
                            <h6 class="text-center fw-bold">CONTEO POR LOTE</h6> 
                            <div v-if="msg_lote" :class="`alert alert-${type_msg_lote} text-center p-2 m-0`" role="alert" style="font-size: smaller;">
                                {{msg_lote}}
                            </div>
                            <mark><label class="fw-bold m-0 p-0">Lote:</label> {{item.lote_id}}</mark><br>
                            <label class="fw-bold m-0 p-0">F.Elab:</label> {{item.fecha_elab_lote}}<br>
                            <label class="fw-bold m-0 p-0">F.Cadu:</label> {{item.fecha_cadu_lote}}<br>
                            <form @submit.prevent="actualizarItem(formLote.id)">
                                <label>Unidades por cartón:</label>
                                <input class="form-control form-control-sm" v-model="formLote.unidades_caja" type="number">
                                <label>Número de cartones totales:</label>
                                <input class="form-control form-control-sm" v-model="formLote.numero_cajas" type="number">
                                <label>Unidades sueltas totales:</label>
                                <input class="form-control form-control-sm" v-model="formLote.unidades_sueltas" type="number">
                                <label>Observaciones:</label>
                                <textarea class="form-control form-control-sm" v-model="formLote.observaciones"></textarea>
                                <label class="fw-bold">Total Unidades:</label> {{ conteo_fisico_lote }}<br>
                                <button type="submit" class="btn btn-sm btn-primary float-sm-end mt-2">GUARDAR</button>
                            </form>                      
                        </div>
                    </div>
                
                </div>
                {% endverbatim %}
            </div>
        </div>
    </div>
</div>

<script>

    new Vue({
        el: '#app',
        data: {
            // LISTADO
            mi_bodega:'',
            mi_ubicacion:'',
            n_inventario:'',
            n_inventario_nollenado:'',
            n_inventario_llenado:'',
            stock:[],

            // ITEM
            item:'',

            // TOTALES
            type_msg_totales:'',
            msg_totales:'',
            formTotales:{
                product_id_t:'',
                ware_code_t:'',
                location_t:'',
                unidades_caja_t:'',
                numero_cajas_t:'',
                unidades_sueltas_t:'',
                user_id: Number(document.getElementById("user-id").value)
            },

            // LOTES
            lotes:[],
            total_lotes:'',
            
            // CONTEO LOTE
            type_msg_lote:'',
            msg_lote:'',
            formLote:{
                unidades_caja:'',
                numero_cajas:'',
                unidades_sueltas:'',
                observaciones:'',
                llenado:true,
                user_id: Number(document.getElementById("user-id").value)
            },
            
        },
        mounted() {
            this.getStock();
        },
        computed: {
            total_agrupado() {
                const u_cajas_t = this.formTotales.unidades_caja_t ? this.formTotales.unidades_caja_t : 0;
                const n_cajas_t = this.formTotales.numero_cajas_t ? this.formTotales.numero_cajas_t : 0;
                const u_sueltas_t = this.formTotales.unidades_sueltas_t ? this.formTotales.unidades_sueltas_t : 0;
                return Number(u_cajas_t * n_cajas_t) + Number(u_sueltas_t)
            },
            conteo_fisico_lote() {
                const u_cajas = this.formLote.unidades_caja ? this.formLote.unidades_caja : 0;
                const n_cajas = this.formLote.numero_cajas ? this.formLote.numero_cajas : 0;
                const u_sueltas = this.formLote.unidades_sueltas ? this.formLote.unidades_sueltas : 0;
                return Number(u_cajas * n_cajas) + Number(u_sueltas)
            },
            diferencia() {
                const t_lotes = this.total_lotes ? this.total_lotes : 0;
                const t_agrupado = this.total_agrupado ? this.total_agrupado : 0;
                return Number(t_lotes - t_agrupado)
            },
        },
        methods: {
            llenadoColor(llenado) {
                switch (llenado) {
                    case true:
                        return '#BAF690';
                }
            },

            diferenciaColor(diferencia){
                if (diferencia === 0) {
                    return '#BAF690';
                } else {
                    return '#F6B690';
                }
            },

            sumarInput(input, name) {

                if (input.includes('+')) {
                    let array = input.split('+');
                    let n_uno = array[0];
                    let n_dos = array[1];
                    if (n_dos) {
                        let total = Number(n_uno) + Number(n_dos);
                        this.formTotales[name] = Number(total);
                    }
                } else if (input.includes('-')) {
                    let array = input.split('-');
                    
                    let n_uno = array[0];
                    let n_dos = array[1];
                    if (n_dos) {
                        let total = Number(n_uno) - Number(n_dos);
                        this.formTotales[name] = Number(total);
                    }
                }
            },

            async getStock () {
                const url = window.location.href;
                const params = url.split('/');
                const bodega = params[5];
                const my_location = params[6];
                try {
                    const response = await fetch(`/inventario/inv/${bodega}/${my_location}`);
                    const data = await response.json();
                    this.mi_bodega = data.mi_bodega;
                    this.mi_ubicacion = data.mi_ubicacion;
                    this.n_inventario = data.n_inventario;
                    this.n_inventario_nollenado = data.n_inventario_nollenado;
                    this.n_inventario_llenado = data.n_inventario_llenado;
                    this.stock = data.inventario || [];
                } catch (error) {
                    console.log(error);
                }
            },

            async getItem(item_id) {
                
                try {
                    const response = await fetch(`/inventario/toma-fisica/${item_id}`);
                    const data = await response.json();
                    
                    // Item
                    this.item = data.item;

                    // List de lotes
                    this.lotes = this.stock.filter(i => 
                        i.product_id == this.item.product_id &&
                        i.ware_code == this.item.ware_code &&
                        i.location == this.item.location);
                    
                    // Total lotes
                    this.total_lotes = this.lotes.reduce((acumulador, unidades) => acumulador + unidades.total_unidades, 0)

                    // Form totales
                    if (data.item_totales){
                        this.formTotales.id = data.item_totales.id;
                        this.formTotales.product_id_t = data.item_totales.product_id_t;
                        this.formTotales.ware_code_t = data.item_totales.ware_code_t;
                        this.formTotales.location_t = data.item_totales.location_t;
                        this.formTotales.unidades_caja_t = data.item_totales.unidades_caja_t;
                        this.formTotales.numero_cajas_t = data.item_totales.numero_cajas_t;
                        this.formTotales.unidades_sueltas_t = data.item_totales.unidades_sueltas_t;
                        
                    } 
                    else {
                        this.formTotales.id = null;  
                        this.formTotales.product_id_t = data.item.product_id;
                        this.formTotales.ware_code_t = data.item.ware_code;
                        this.formTotales.location_t = data.item.location;
                        this.formTotales.unidades_caja_t = data.item.unidades_caja;
                    }
                    
                    // Form lote 
                    this.formLote.id = data.item.id;
                    this.formLote.unidades_caja = data.item.unidades_caja;
                    this.formLote.numero_cajas = data.item.numero_cajas;
                    this.formLote.unidades_sueltas = data.item.unidades_sueltas;

                    setTimeout(
                        () => {
                            this.msg_lote = '';
                            this.msg_totales = '';
                        }, 3000)

                    
                } catch (error) {
                    console.error(error);
                }
            },

            async actualizarCrearTotal() {
                try {
                    const response = await fetch('/inventario/toma-fisica/total-agrupado', { 
                        method: 'POST',
                        headers: {'Content-Type': 'application/json',},
                        body: JSON.stringify(this.formTotales)
                    });
                    const data = await response.json();
                    this.type_msg_totales = data.type;
                    this.msg_totales = data.msg;
                    
                } catch (error) {
                    this.msg_totales = error;
                    this.type_msg_totales = 'danger';
                }
            },
            
            async actualizarItem(item_id) {
                try {
                    const response = await fetch(`/inventario/toma-fisica/${item_id}`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json',},
                        body: JSON.stringify(this.formLote)
                    });
                    const data = await response.json();

                    this.type_msg_lote = data.type;
                    this.msg_lote = data.msg; 

                    await this.getStock();
                    await this.getItem(item_id);        
                    
                } catch (error) {
                    this.type_msg_lote = 'danger';
                    this.type_msg_item = error;
                }
            },
        }
    })
</script>
{% endblock %}