{% extends 'base_vue.html' %}

{% block title %}
<title>DB WAREHOUSE</title>
{% endblock %}

{% block body %}

<div id="app">

    <h5 class="text-center m-4 fw-bold">LISTADO DE TABLAS</h5>

    <div class="mb-3">
        <button @click="actualizarAutomatica" class="btn btn-primary" type="button">
            <span v-if="actualizandoTodo" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
            ACTUALIZAR TODO
        </button>

        <small class="text-muted ms-3">
            ℹ️ Las tablas se actualizan automáticamente en el servidor (Celery) cada 15-30 min
        </small>
    </div>

    <!--div>
    {% verbatim %}
        <span>Hora actual: {{hora_actual}}</span>
    {% endverbatim %}
    </div-->

    <div class="card mb-4">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table" style="font-size:small">
                    <thead>
                        <tr>
                            <th scope="col">ORDEN</th>
                            <th scope="col">TABLA</th>
                            <th scope="col">ULTIMA ACTUALIZACIÓN</th>
                            <th scope="col">AUTOMATICO</th>
                            <th scope="col">PERIODICIDAD</th>
                            <th scope="col">MENSAJE</th>
                            <!--th scope="col">MILISEGUNDOS</th-->
                            <th scope="col">Conexión Actual</th>
                            <th scope="col">Cambiar Conexión</th>
                            <th scope="col">ACTUALIZAR</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="i in tablasData">
                            {% verbatim %}
                            <td>{{i.orden}}</td>
                            <td><code>{{i.table_name}}</code></td>
                            <td>{{i.datetime}}</td>
                            <td class="text-center" v-if="i.automatico"><i style="color:green" class="bi bi-check-circle"></i></td>
                            <td class="text-center" v-else><i style="color:red" class="bi bi-x-circle"></i></td>
                            <td>{{i.periodicidad}}</td>
                            <!--td>{{i.milisegundos}}</td-->
                            <td>{{i.mensaje}}</td>
                            <td class="text-center"><code> {{i.conexion}} </code></td>
                            <td class="text-center">
                                
                                <div v-show="i.table_name == 'clientes' || i.table_name == 'stock_lote' || i.table_name == 'reservas_lote'">
                                    <button v-show="i.conexion == 'odbc'" @click="cambiarConexion(i.table_name, 'api')" class="btn btn-sm btn-primary">
                                        api
                                    </button>
                                    <button v-show="i.conexion == 'api'" @click="cambiarConexion(i.table_name, 'odbc')" class="btn btn-sm btn-success">
                                        odbc
                                    </button>
                                </div>                                
                            </td>
                            <td class="text-center">
                                <button @click="actualizarTablaWarehouse(i.table_name)" class="btn btn-sm btn-success">
                                    <span v-if="i.actualizandoEstaTabla" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                    <i class="bi bi-arrow-clockwise"></i>
                                </button>
                            </td>
                            {% endverbatim %}
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    const adminDataUrl = "{% url 'admin_actualizar_warehouse_json_response' %}";
    // CRÍTICO: Intervalos aumentados para reducir carga en API MBA
    const cadaQuinceMin = 15 * 60 * 1000;    // 15 minutos
    const cadaTreintaMin = 30 * 60 * 1000;   // 30 minutos
    const cadaUnaHora = 60 * 60 * 1000;      // 1 hora
    new Vue({
        el: '#app',
        data: {
            hora_actual: '',
            actualizandoTodo:false,
            tablas:[],
            actualizacionesEnProgreso: new Set(), // Prevenir ejecuciones concurrentes
        },
        mounted() {
            this.getDatosAdminWarehouse();

            // Auto-refrescar cada 2 horas (solo para mostrar timestamps actualizados)
            setInterval(() => {
                this.getDatosAdminWarehouse();
            }, 2 * 60 * 60 * 1000); // 2 horas
        },
        computed:{
            tablasData() {
                return this.tablas.map(i => {
                    return {
                        ...i,
                        datetime: new Date(i.datetime).toLocaleString(),
                    }
                })
            }
        },
        methods: {
            async getDatosAdminWarehouse() {
                try {
                    const response = await fetch(adminDataUrl);
                    if (!response.ok) {
                        throw new Error(response.statusText);
                    }
                    const data = await response.json();
                    //this.tablas = data || [];
                    this.tablas = data.map((i) => ({
                        ...i,
                        actualizandoEstaTabla: false
                    }))
                    
                } catch (error) {
                    console.error(error);
                }
            },

            async actualizarTablaWarehouse(table_name) {
                // PROTECCIÓN: Evitar ejecuciones concurrentes de la misma tabla
                if (this.actualizacionesEnProgreso.has(table_name)) {
                    console.log(`⏳ Actualización de ${table_name} ya en progreso, saltando...`);
                    return;
                }

                const tabla = this.tablas.find((i) => i.table_name === table_name);
                if (!tabla) return;

                // Marcar como en progreso
                this.actualizacionesEnProgreso.add(table_name);
                this.$set(tabla, 'actualizandoEstaTabla', true);

                try {
                    const response = await fetch("/datos/stocklote", {
                        method: "POST",
                        headers: {"Content-Type": "application/json",},
                        body:JSON.stringify({table_name}),
                    });
                    if (!response.ok) {
                        throw new Error(response.statusText);
                    }

                    await this.getDatosAdminWarehouse();
                } catch (error) {
                    console.error(`❌ Error actualizando ${table_name}:`, error);
                } finally {
                    // Liberar el lock
                    this.actualizacionesEnProgreso.delete(table_name);
                    this.$set(tabla, 'actualizandoEstaTabla', false);
                }
            },

            async actualizarAutomatica() {
                this.actualizandoTodo = true;
                
                const ahora = new Date();
                const horaActual = ahora.getHours();
                const minutosActual = ahora.getMinutes();
                
                // Convertir a minutos totales para comparación fácil
                const minutosTotales = horaActual * 60 + minutosActual;
                
                // Definir límites (5:30 AM = 5*60+30 = 330, 22:00 = 22*60 = 1320)
                const inicio = 5 * 60 + 30;  // 5:30 AM
                const fin = 22 * 60;         // 22:00 PM
                
                // Verificar si está dentro del horario permitido
                if (minutosTotales < inicio || minutosTotales > fin) {
                    console.log("Fuera del horario permitido (7:30 AM - 6:00 PM)");
                    this.actualizandoTodo = false;
                    return; // Salir de la función
                }

                try {
                    const response = await fetch("/datos/stocklote", {
                        method: "POST",
                        headers: {"Content-Type": "application/json",},
                        body:JSON.stringify({"get":"automatica"}),
                    });
                    if (!response.ok) {
                        throw new Error(response.statusText);
                    }  
                    this.getDatosAdminWarehouse();
                    this.actualizandoTodo = false;
                    
                } catch (error) {
                    console.error(error);
                } finally {
                    this.actualizandoTodo = false;
                }
            },

            async cambiarConexion(table_name, nueva_conexion) {
                try {
                    const response = await fetch("/datos/cambiar_conexion_de_warehouse", {
                        method: "POST",
                        headers: {"Content-Type": "application/json",},
                        body:JSON.stringify({table_name, nueva_conexion}),
                    });
                    if (!response.ok) {
                        throw new Error(response.statusText);
                    }

                    if (response.tipo == 'fail') {
                        alert("No se pudo cambiar la conexión");
                        return;
                    }
                    
                    await this.getDatosAdminWarehouse();
                } catch {
                    console.error(error);
                }
            },

            // hora_actual() {
            //     return this.hora_actual = new Date().toLocaleTimeString();
            // }

        },
    })
</script>

{% endblock %}