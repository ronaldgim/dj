{% extends 'base.html' %}

{% block title %}
<title>Reporte Ventas</title>
{% endblock %}

{% block navbar %}
{% include 'ventas/topnavbar.html' %}
{% endblock %}

{% block body_2 %}

<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>


<h5 class="m-4 text-center"><strong>REPORTE VENTAS</strong></h5>

<div class="mb-4">
<form method="GET">
    <div class="row">
        <div class="col-6">
            <label>Cliente:</label>
            <select class="form-select" name="cliente" id="chosen-select" required>
                <option value="">---------</option>
                {% for i in clientes %}
                    <option value="{{i.codigo_cliente}}"
                        {% if i.codigo_cliente == request.GET.cliente %}selected{% endif %}>
                        {{i.nombre_cliente}}
                    </option>
                {% endfor %}
            </select>
        </div>

        <div class="col-3">
            <label>Desde:</label>
            <input 
                class="form-control" 
                type="date" 
                name="desde"
                value="{{request.GET.desde|default:desde}}" 
                required
            >
        </div>

        <div class="col-3">
            <label>Hasta:</label>
            <input 
                class="form-control" 
                type="date" 
                name="hasta"
                value="{{request.GET.hasta|default:hasta}}" 
                required
            >
        </div>
    </div>

    <button class="btn btn-primary mt-2" type="submit" id="btnConsultar">
        <i class="bi bi-search"></i> Consultar
    </button>
</form>
</div>

{% if cliente %}
<h5 class="text-center"><strong>{{cliente}}</strong></h5>
<h6 class="text-center">
    <strong>Desde:</strong> {{desde}}
    <strong>Hasta:</strong> {{hasta}}
</h6>
{% endif %}

{% if messages %}
    {% for message in messages %}
        <div class="alert alert-{{message.tags}} text-center">
            {{message}}
        </div>
    {% endfor %}
{% endif %}

{% if ventas %}

<div class="col-4 mb-2">
    <input id="inputbuscar" type="text" placeholder="Buscar" class="form-control" disabled>
</div>

<div class="card">
<div class="card-body">
<div class="table-responsive">

<table class="table table-hover" id="myTable">
    <thead>
        <tr>
            <th>Código</th>
            <th>Nombre</th>
            <th>Marca</th>
            <th>Und</th>
            <th>Fecha</th>
            <th>Factura</th>
            <th class="text-end">Cantidad</th>
            <th class="text-end">P/Unitario</th>
            <th class="text-end">Valor</th>
        </tr>
    </thead>

    <tbody id="pedidosbuscar">
        {% for i in ventas %}
        <tr>
            <td class="producto-cod">{{i.PRODUCT_ID}}</td>
            <td>{{i.Nombre}}</td>
            <td>{{i.Marca}}</td>
            <td>{{i.Unidad}}</td>
            <td>{{i.FECHA}}</td>
            <td>
                {{i.CODIGO_FACTURA|slice:'6:19'}}
                <button 
                    type="button"
                    data-factura="{{i.CODIGO_FACTURA}}"
                    class="btn btn-outline-primary btn-sm btnFactura">
                    <i class="bi bi-list-ol"></i>
                </button>
            </td>
            <td class="text-end">{{i.QUANTITY|floatformat:0}}</td>
            <td class="text-end">$ {{i.UNIT_PRICE|floatformat:2}}</td>
            <td class="text-end">$ {{i.PRECIO_TOTAL|floatformat:2}}</td>
        </tr>
        {% endfor %}
    </tbody>

    <tfoot class="table-light fw-bold">
        <tr>
            <td colspan="6">Totales:</td>
            <td class="text-end">{{total_cantidad}}</td>
            <td></td>
            <td class="text-end">$ {{total_ventas}}</td>
        </tr>
    </tfoot>

</table>

</div>
</div>
{% elif request.GET.cliente %}
<div class="alert alert-warning text-center">
    No hay ventas en el período seleccionado.
</div>
{% endif %}

</div>

<script>
$(document).ready(function() {
    setTimeout(function() {
        document.getElementById('inputbuscar').disabled = false;
    }, 500); // 500 milisegundos = 1/2 segundo
});

$(document).ready(function(){

    $('#chosen-select').select2({
        width: '100%'
    });

    $('.btnFactura').on('click', function(){

        let btn = $(this);
        let fac = btn.data('factura');
        let cod = btn.closest('tr').find('.producto-cod').text();
        let parentRow = btn.closest('tr');

        let existing = parentRow.next('.child-row');

        if(existing.length){
            existing.remove();
            return;
        }

        parentRow.after(`
            <tr class="child-row">
                <td class="text-center" colspan="9">Cargando...</td>
            </tr>
        `);

        $.ajax({
            url:"{% url 'lote_factura_ajax' %}",
            type:"POST",
            headers: { "X-CSRFToken": "{{ csrf_token }}" },
            data:{
                fac: fac,
                cod: cod
            },
            success:function(response){
                parentRow.next('.child-row').replaceWith(`
                    <tr class="child-row" style='background-color: #cdffd6'>
                        <td colspan="5"></td>
                        <td colspan="4">${response}</td>
                    </tr>
                `);
            },
            error:function(){
                parentRow.next('.child-row').replaceWith(`
                    <tr class="child-row table-danger">
                        <td class="text-center" colspan="9">Error al cargar información</td>
                    </tr>
                `);
            }
        });

    });

});

$(document).ready(function() {
    $("#inputbuscar").on("keyup", function() {
        var value = $(this).val().toLowerCase();
        $("#pedidosbuscar tr").filter(function() {
            $(this).toggle($(this).text()
            .toLowerCase().indexOf(value) > -1)
        });
    });
});

</script>

<link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.css" />  
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.js"></script>

<script>
    $(document).ready(function(){
        $('#myTable').DataTable({
            //#ordering:false,
            "order":[],
            "searching":false,
            "show":false,
            "paging":false,
            "info":false,
            columnDefs:[
                {type:'signed-num',targets:0}
            ]
        })
    })
</script>

{% endblock %}
