{% extends 'base_vue.html' %}

{% block title %}
<title>DASHBOARD COMPLETO CEREZOS</title>
{% endblock %}

{% block body_2 %}

<div id="app">

    <!-- HEADER -->
    <div class="text-center mt-2 mb-3">
        <h1 class="fw-bold d-inline">DASHBOARD COMPLETO CEREZOS</h1>

        <div v-if="loading" class="spinner-border ms-2" role="status"></div>
        <div v-if="error" class="ms-2 text-danger">
            <i class="bi bi-bug-fill"></i> Error cargando datos
        </div>
    </div>

    <!-- FILTROS -->
    <div class="row mb-3">
        <div class="col-md-3">
            <input type="date" v-model="filtros.fecha_inicio" class="form-control">
        </div>
        <div class="col-md-3">
            <input type="date" v-model="filtros.fecha_fin" class="form-control">
        </div>
        <div class="col-md-3">
            <select v-model="filtros.bodega" class="form-select">
                <option value="">Todas las bodegas</option>
                <option value="BAN">ANDAGOYA</option>
                <option value="BCT">CEREZOS</option>
            </select>
        </div>
        <div class="col-md-3">
            <button class="btn btn-primary w-100" @click="cargarDashboard">
                Aplicar filtros
            </button>
        </div>
    </div>

    <!-- KPIs -->
    <div class="row mb-4">
        <div class="col-md-3" v-for="(valor, key) in kpisPrincipales" :key="key">
            <div class="card text-center shadow-sm">
                <div class="card-body">
                    <h6 class="text-muted">{{ key }}</h6>
                    <h4 class="fw-bold">{{ valor }}</h4>
                </div>
            </div>
        </div>
    </div>

    <!-- SLA -->
    <div class="card mb-4">
        <div class="card-header fw-bold">
            Cumplimiento SLA
        </div>
        <div class="card-body">
            <div v-for="(sla, etapa) in dashboard.slas_reales.slas" :key="etapa">
                {% verbatim %}
                <strong>{{ etapa }}</strong>:
                {{ sla.porcentaje_cumplimiento.toFixed(2) }}
                <div class="progress mb-2">
                    <div class="progress-bar"
                        :style="{ width: sla.porcentaje_cumplimiento + '%' }">
                    </div>
                </div>
                {% endverbatim %}
            </div>
        </div>
    </div>

    <!-- CHART -->
    <div class="card">
        <div class="card-header fw-bold">
            Tendencia pedidos (diario)
        </div>
        <div class="card-body">
            <div id="chartPedidos" style="height:400px;"></div>
        </div>
    </div>

</div>

<!-- VUE APP -->
<script>
new Vue({
    el: '#app',
    data() {
        return {
            loading: false,
            error: false,
            dashboard: {
                kpis_operativos: {},
                slas_reales: { slas: {} },
                tendencias_diarias: []
            },
            filtros: {
                fecha_inicio: '',
                fecha_fin: '',
                bodega: '',
                cliente: ''
            }
        }
    },
    computed: {
        kpisPrincipales() {
            const k = this.dashboard.kpis_operativos || {}
            return {
                'Pedidos': k.total_pedidos || 0,
                'Ãtems': k.total_items || 0,
                'Volumen m3': (k.total_volumen_m3 || 0).toFixed(2),
                'Peso Kg': (k.total_peso_kg || 0).toFixed(2),
                'Tiempo Promedio (min)': (k.tiempo_promedio_total || 0).toFixed(1)
            }
        }
    },
    mounted() {
        this.cargarDashboard()
    },
    methods: {
        cargarDashboard() {
            this.loading = true
            this.error = false

            const params = new URLSearchParams(this.filtros).toString()

            fetch(`/etiquetado/dashboard_completo_api/?${params}`)
                .then(res => res.json())
                .then(data => {
                    this.dashboard = data
                    this.renderChart()
                })
                .catch(() => this.error = true)
                .finally(() => this.loading = false)
        },
        renderChart() {
            const chart = echarts.init(document.getElementById('chartPedidos'))

            const data = this.dashboard.tendencias_diarias || []

            chart.setOption({
                tooltip: { trigger: 'axis' },
                xAxis: {
                    type: 'category',
                    data: data.map(d => d.periodo)
                },
                yAxis: { type: 'value' },
                series: [{
                    name: 'Pedidos',
                    type: 'line',
                    smooth: true,
                    data: data.map(d => d.total_pedidos)
                }]
            })
        }
    }
})
</script>

{% endblock %}