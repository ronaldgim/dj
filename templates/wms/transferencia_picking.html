{%extends 'base.html' %}

{% block title %}
<title>Trasferencia {{n_transf}}</title>
{% endblock%}

{% block navbar %}
{% include 'wms/topnavbar.html' %}
{% endblock %}

{% block body %}

<style>
    .btn.btn-warning.btn-sm.active {
    background-color: blue;}

    .mensaje-temporal {
        display: none;
        position: absolute;
        background-color: #4CAF50;
        color: white;
        padding: 10px;
        border-radius: 5px;
    }

    #msg_ss {
        display: none;
        position: fixed; /* Cambiado a fixed para que sea relativo a la ventana */
        /*bottom: 10px; */ /* Distancia desde la parte inferior */
        top:40%;
        right: 10px; /* Distancia desde la derecha */
        /*background-color: #4CAF50;*/
        color: white;
        padding: 10px;
        border-radius: 5px;
        width:auto;
        z-index: 3;
        }
</style>

<h6 class="mt-2 text-center"><strong>Trasferencia {{n_transf}}</strong></h6>


{% if messages %}
{% for message in messages %}
{% if message.tags == 'success'%}
<div class="alert text-center alert-success" role="alert">
    {{message}}
</div>
{% elif message.tags == 'error'%}
<div class="alert text-center alert-danger" role="alert">
    {{message}}
</div>
{%endif%}
{% endfor %}
{% endif %}

<div id="msg"></div>
<div id="msg_ss"></div>

{% if factura.msg %}
    <div class="alert text-center alert-danger" role="alert">
        {{factura.msg}}
    </div>
{% endif %}

<div class="card mb-2">
    <div class="card-body m-0 p-0">
        <div class="container table-responsive">
            <table class="table m-0 p-0" style="font-size: small;">
                <thead>
                    <tr>
                        <th scope="col">Item</th>
                        <th scope="col">Lote</th>
                        <th scope="col">Unidades</th>
                        <th scope="col">Ubicación(es)</th>
                    </tr>
                </thead>
                <tbody id="pedidosbuscar">
                    {% for i in transf %}
                    <tr>
                        <td><span id="product_id">{{i.product_id}}</span><br>{{i.Nombre}} - {{i.Marca}}
                        </td>
                        <td><span id="lote_id">{{i.lote_id}}</span><br>{{i.fecha_caducidad}}</td>
                        <td
                            {% if i.unidades == i.unidades_wms %}
                            style="background-color: #e3fde6;"
                            {% elif not i.unidades_wms or i.unidades_wms < i.unidades %}
                            style="background-color: #F6F490;"
                            {% elif i.unidades < i.unidades_wms %}
                            style="background-color: #F6B690;"
                            {% endif %}
                        >
                            MBA: {{i.unidades|floatformat:"0g"}}<br>
                            WMS: {{i.unidades_wms|floatformat:"0g"}}
                        </td>
                        <td class="text-end">
                            <button class="btn btn-primary btn-sm" name="boton_ubicaciones"> 
                                <i class="bi bi-geo-fill"></i>
                            </button>
                        </td>
                    </tr>
                    
                    {# FILA OCULA CON INVENTARIO Y MOVIMIENTOS #}
                    <tr id="detalle_ubicaciones" style="display:none;" class="m-0 p-0">
                        <td colspan="4">
                            <h6 class="fw-bold" style="font-size: small;">Inventario</h6>
                            <table class="table" style="font-size: small;">
                                <thead>
                                    <tr style="background-color: #e6e6e6;">
                                        <th scope="col">Ubicación</th>
                                        <th scope="col">Dips</th>
                                        <th scope="col">Unds-Transferencia</th>
                                        <th scope="col">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {# TABLA INVENTARIO #}
                                    {% if i.ubi %}
                                        {% for j in i.ubi %}
                                        <tr style="background-color: #e6e6e6;">
                                            <td>{{j.ubicacion__bodega}}-{{j.ubicacion__pasillo}}-{{j.ubicacion__modulo}}-{{j.ubicacion__nivel}}</td>
                                            <td>{{j.unidades|floatformat:"0g"}}</td>
                                            <td>
                                                <input type="number" class="form-control form-control-sm">
                                            </td>
                                            <td>
                                                <button type="button" class="btn btn-success btn-sm">
                                                    <i class="bi bi-arrow-bar-right"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    {% endif %}

                                    {# TABLA PICKING #}
                                    {% if i.pik %}
                                    <tr>
                                        <td colspan="4" class="m-0 p-0">
                                            <h6 class="fw-bold" style="font-size: small;">Picking</h6>
                                            <table class="table m-0 p-0" style="background-color: #edfdff;">
                                                <thead>
                                                    <tr>
                                                        <th scope="col">Ubicación</th>
                                                        <th scope="col">Unds-Transferencia</th>
                                                        <th scope="col">Acciones</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for k in i.pik %}
                                                    <tr>
                                                        <td>{{k.ubicacion__bodega}}-{{k.ubicacion__pasillo}}-{{k.ubicacion__modulo}}-{{k.ubicacion__nivel}}</td>
                                                        <td>{{k.unidades|floatformat:"0g"}}</td>
                                                        <td>
                                                            <button class="btn btn-sm btn-danger" name="eliminar_picking" id="{{k.id}}">
                                                                <i class="bi bi-arrow-bar-left"></i>
                                                            </button>
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        <td>
                                    </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    {% comment %}
    $("button[name='boton_ubicaciones']").click(function(){
        var fila = $(this).closest("tr").toggleClass("table-info") //.addClass("table-info")
        var product_id = $(this).closest("tr").find("#product_id").html()
        var lote_id    = $(this).closest("tr").find("#lote_id").html()
        console.log(product_id, lote_id)
    })
    {% endcomment %}
    $(document).ready(function(){
        $("button[name='boton_ubicaciones']").click(function(){
            var fila = $(this).closest("tr")
            fila.next("#detalle_ubicaciones").toggle();
            fila.toggleClass("table-info")
        })
    })
</script>
{% comment %}
<script>

    $("button[name='boton_ubicaciones']").click(function(){
        var fila = $(this).closest("tr").toggleClass("table-info") //.addClass("table-info")
        var product_id = $(this).closest("tr").find("#product_id").html()
        var lote_id    = $(this).closest("tr").find("#lote_id").html()
        console.log(product_id, lote_id)
        
        $.ajax({
            type:"POST",
            url:"{% url 'wms_transferencia_input_ajax' %}",
            data:{
                'csrfmiddlewaretoken': '{{ csrf_token }}',
                'n_trasf':n_trasf,
            },

            success: function(response) {
                $('#msg').fadeIn().html(`<div class="text-center alert alert-danger" role="alert"> ${response} !!! </div>`).fadeOut(6000)
            },
            
            error: function() {
                $('#msg').fadeIn().html('<div class="text-center alert alert-danger" role="alert"> Error !!! </div>').fadeOut(6000)
            }
        })
        
    })
</script>
{% endcomment %}
{% endblock %}