{%extends 'base_vue.html' %}

{% block title %}
<title>Transferencia</title>
{% endblock%}

{% block navbar %}
{% include 'inventario/topnavbar.html' %}
{% endblock %}

{% block body_2 %}

<div id="app">

    <h5 class="m-4 text-center fw-bold">INVENTARIO TRANSFERENCIA</h5>
    
    <div class="card">
        <div class="card-header">STOCK PARA TRANSFERENCIA</div>
        <div class="card-body">
            <label class="fw-bold">Código:</label>
            <div class="col-md-3 col-sm-6">
                <select v-model="filtro" class="form-select">
                    <option value="">Todos</option>
                    <option v-for="producto in product_list" :key="producto" :value="producto">
                        {% verbatim %}
                            {{ producto }}
                        {% endverbatim %}
                    </option>
                </select>
            </div>
            <div class="table-responsive">
                <table class="table" id="inv_table" style="font-size: small;">
                    <thead>
                        <tr class="text-smaller">
                            <th><span style="white-space: nowrap;">Código</span></th>
                            <th><span style="white-space: nowrap;">Nombre</span></th>
                            <th> <span style="white-space: nowrap;">Marca</span></th>
                            <th><span style="white-space: nowrap;">Lote</span></th>
                            <th><span style="white-space: nowrap;">F.Cadu</span></th>
                            <th><span style="white-space: nowrap;">Bod</span></th>
                            <th><span style="white-space: nowrap;">BAN</span></th>
                            <th><span style="white-space: nowrap;">CUC</span></th>
                            <th style="background-color:#F6B690;"><span style="white-space: nowrap;">BAN-R</span></th>
                            <th style="background-color:#F6B690;"><span style="white-space: nowrap;">BCT-R</span></th>
                            <th style="background-color:#E1FFC9;"><span style="white-space: nowrap;">BCT</span></th>
                            <th style="background-color:#C9FFFD;"><span style="white-space: nowrap;">BCT-D</span></th>
                            <th><span style="white-space: nowrap;">TRANSF</span></th>
                            <th><span style="white-space: nowrap;">D.PROD</span></th>
                            <th><span style="white-space: nowrap;">TOTALES</span></th>
                            <th><span style="white-space: nowrap;">ACCIONES</span></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% verbatim %}
                        <tr>
                            <td v-if="actualizandoStock" colspan="16" class="text-center fs-1">Cargando...</td>
                        </tr>
                        <tr v-for="(i, index) in stockFiltrado" :key="index">
                            <td>{{i.product_id}}</td>
                            <td class="text-wraped" style="width:100px">{{i.Nombre}}</td>
                            <td>{{i.Marca}}</td>
                            <td>
                                <i v-if="i.error_lote == true" class="bi bi-exclamation-triangle-fill" style="color:red"></i>
                                {{i.lote_id}}
                            </td>
                            <td>{{i.fecha_caducidad}}</td>
                            <td>
                                {{i.location}}
                            </td>
                            <td class="text-end">{{i.BAN.toLocaleString()}}</td>
                            <td class="text-end">{{i.CUC.toLocaleString()}}</td>
                            <td class="text-end" style="background-color:#F6B690;">{{i.BAN_R.toLocaleString()}}</td>
                            <td class="text-end" style="background-color:#F6B690;">{{i.BCT_R.toLocaleString()}}</td>
                            <td style="background-color:#E1FFC9;">
                                <div class="d-flex justify-content-between">
                                    <span class="text-start fw-bold">Unds:</span>
                                    <span class="fw-bold" v-if="i.BCT!=0">{{ i.BCT.toLocaleString() }}</span>
                                    <span class="fw-bold" v-else>0</span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span class="text-start fw-bold">Sald:</span>
                                    <span v-if="i.BCT_S != null || i.BCT_S > 0">{{ i.BCT_S.toLocaleString() }}</span>
                                    <span v-else>S: 0</span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span class="text-start fw-bold">Cart:</span>
                                    <span v-if="i.BCT_C != null || i.BCT_C > 0">{{ i.BCT_C.toLocaleString() }}</span>
                                    <span v-else>C: 0</span>
                                </div>                                
                            </td>
                            <td style="background-color:#C9FFFD;">
                                <div class="d-flex justify-content-between">
                                    <span class="text-start fw-bold">Unds:</span>
                                    <span class="text-end fw-bold" v-if="i.BCT_D != 0">{{ i.BCT_D.toLocaleString() }}</span>
                                    <span class="fw-bold" class="text-end" v-else>0</span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span class="text-start fw-bold">Sald:</span>
                                    <span v-if="i.BCT_D_S != null || i.BCT_D_S > 0">{{ i.BCT_D_S.toLocaleString() }}</span>
                                    <span class="fw-bold" v-else>0</span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span class="text-start fw-bold">Cart:</span>
                                    <span v-if="i.BCT_D_C != null || i.BCT_D_C > 0">{{ i.BCT_D_C.toLocaleString() }}</span>
                                    <span class="fw-bold" v-else>0</span>
                                </div>
                            </td>
                            <td class="text-end">                                
                                <i v-if="i.totalUnidades == 0" class="bi bi-megaphone"></i>
                                <div v-if="i.totalUnidades > 0">
                                    <i v-if="i.totalUnidades <= i.BCT_D" class="bi bi-box2-fill" style="color:green"></i>
                                    <i v-else-if="i.totalUnidades > i.BCT_D && i.totalUnidades <= i.BCT" class="bi bi-box2-fill" style="color:yellow"></i>
                                    <i v-else-if="i.totalUnidades > i.BCT" class="bi bi-box2-fill" style="color:red"></i>
                                    <span v-if="i.totalUnidades > i.BCT_D">{{ i.calculoReserva.toLocaleString() }}</span>
                                </div>
                                
                                <div class="d-flex justify-content-between">
                                    <span class="text-start fw-bold">Sald:</span>
                                    <input type="number" v-model.number="i.inputSaldos" min="1" style="width:80px" :disabled="i.bodega == 'BAN' || i.BCT == 0"/>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span class="text-start fw-bold">Cart:</span>
                                    <input type="number" v-model.number="i.inputCartones" min="1" style="width:80px" :disabled="i.bodega == 'BAN' || i.BCT == 0"/>
                                </div>
                            </td>
                            <td class="text-end">
                                <span>{{ i.Unidad_Empaque }} unds</span> <br>
                                <span>{{ i.vol_m3.toFixed(3) }} m3</span> <br>
                                <span>{{ i.Peso.toFixed(3) }} kg</span>
                            </td>
                            <td class="text-end">
                                <span class="text-end fw-bold" style="background-color:#A9FF5E">{{ i.totalUnidades.toLocaleString() }} unds</span> <br>
                                <span class="text-end">{{ i.vol_unitario.toFixed(3) }} m3</span> <br>
                                <span class="text-end">{{ i.peso_unitario.toFixed(3) }} kg</span>
                            </td>
                            <td class="text-center">
                                <div class="btn-group" role="group" aria-label="Basic example">
                                    <button 
                                        v-if="i.detalle" 
                                        type="button" 
                                        name="detail" 
                                        class="btn btn-primary btn-sm"
                                        @click="showDetail(i.detalle, $event)"
                                        >
                                        ...
                                    </button>
                                    <button v-else type="button" name="detail" :value="i.detalle" class="btn btn-primary btn-sm disabled">...</button>
                                    <button type="button" name="add_transf" class="btn btn-success btn-sm {% if len_transf_activas != 1 or i.cartones >= 0 or i.BCT == 0 %} disabled {% endif %}"><i class="bi bi-plus-circle"></i></button>
                                    <button type="button" name="delete_prod" value="{{i.id}}" class="btn btn-danger btn-sm {% if not i.id %} disabled {% endif %}"><i class="bi bi-trash-fill"></i></button>
                                </div>
                            </td>
                        </tr>
                        {% endverbatim %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    new Vue({
        el: '#app',
        data: {
            // FILTRO
            filtro:'',
            product_list:[],
            // STOCK
            actualizandoStock:false,
            stock:[],
            
        },
        mounted() {
            this.getStock();
            this.$nextTick(() => {
                $(".form-select").select2();
            })
        },
        computed:{
            stockFiltrado() {
                let resultadoFiltrado = this.stock
                    .map(i => {
                        // Inicializa campos si no existen
                        if (i.inputSaldos === undefined) {
                            // this.$set(i, 'inputSaldos', 0);
                            this.$set(i, 'inputSaldos');
                        }
                        if (i.inputCartones === undefined) {
                            // this.$set(i, 'inputCartones', 0);
                            this.$set(i, 'inputCartones');
                        }
                        // Calcular totalUnidades siempre que inputCartones o inputSaldos cambien
                        const inputCartones = Number(i.inputCartones) || 0;
                        const unidadEmpaque = Number(i.Unidad_Empaque) || 0;
                        const inputSaldos = Number(i.inputSaldos) || 0;
                        i.totalUnidades = (inputCartones * unidadEmpaque) + inputSaldos;
                        const totalUnidades = Number(i.totalUnidades) || 0;
                        const vol_m3 = Number(i.vol_m3) || 0.025;
                        const cartones = totalUnidades / Number(i.Unidad_Empaque);
                        i.vol_unitario = cartones * vol_m3
                        const peso = Number(i.Peso) || 0
                        i.peso_unitario = cartones * peso;
                        i.calculoReserva = (Number(i.BCT_D) - Number(i.totalUnidades))
                        return i;
                    })
                    .filter(i => {
                        if (!this.filtro) return true;
                        const productId = (i.product_id || '').toString().toLowerCase();
                        return productId === this.filtro.toLowerCase();
                    });

                this.$nextTick(() => {
                    $(".form-select").off('change').on('change', (e) => {
                        this.filtro = e.target.value;
                    });
                });

                return resultadoFiltrado;
            }
        },
        methods: {
            async getStock() {
                this.actualizandoStock = true;
                try {
                    const response = await fetch('/etiquetado/inventario_transferencia_data');
                    const data = await response.json();
                    // Actualizar datos
                    this.stock = data.data || [];
                    this.product_list = data.product_list || [];
                    this.$nextTick(() => {
                        $(".form-select").select2();
                    })
                } catch (error) {
                    console.error(error);
                } finally {
                    this.actualizandoStock = false
                }
            },
            showDetail(detalle, event) {
                this.detalleActual = detalle;
                // Encuentra el botón presionado
                const button = event.currentTarget;
                // Si ya existe el popover, destrúyelo
                if (this._popoverInstance) {
                    this._popoverInstance.dispose();
                }

                // Verifica si el string contiene el caracter '|'
                let rows;
                if (typeof detalle === 'string' && detalle.includes('|')) {
                    // detalle = detalle.replace(/"/g, '')
                    rows = detalle.split('|')
                } else {
                    rows = [detalle]
                }

                let tableHtml = `
                <table class="table table-sm mb-0" style="font-size:smaller">
                    <thead>
                        <th>Cliente</th>
                        <th>Contrato</th>
                        <th>Bodega</th>
                        <th>Unidades</th>
                    </thead>
                    <tbody>`;

                rows.forEach(row => {
                    let col = row.split('-');
                    tableHtml += '<tr>';
                    col.forEach(td => {
                        tableHtml += `<td>${td}</td>`;
                    });
                    tableHtml += '</tr>';
                });
                tableHtml += '</tbody></table>';
                console.log(tableHtml);
                this._popoverInstance = new bootstrap.Popover(button, {
                    content: `<div>${tableHtml}</div>`,
                    html: true,
                    placement: 'bottom',
                    trigger: 'manual',
                    sanitize: false
                });
                // Muestra el popover
                this._popoverInstance.show();
                
                // Guarda el botón activo
                this._activePopoverButton = button;

                // Agrega el listener para cerrar al hacer clic fuera
                this._handleOutsideClick = (e) => {
                    const isClickInside = this._activePopoverButton.contains(e.target) ||
                        document.querySelector('.popover')?.contains(e.target);

                    if (!isClickInside) {
                        this._popoverInstance?.dispose();
                        this._popoverInstance = null;
                        document.removeEventListener('click', this._handleOutsideClick);
                    }
                };

                // Agrega el listener con timeout para evitar que se dispare por el mismo clic
                setTimeout(() => {
                    document.addEventListener('click', this._handleOutsideClick);
                }, 0);
            },
            colorDiferencia(diff) {
                if (diff != 0){
                    return '#F6B690'
                }
            },
        },
    })
</script>
{% endblock %}